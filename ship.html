<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Shipment Creation Backup Solution (Test Environment)- Create Shipments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <link rel="stylesheet" href="styles.css">
	<link rel="icon" href="DBS_Icon3.jpg" type="image/jpg">
	<script>
    if (!sessionStorage.getItem('isRefreshed')) {
        sessionStorage.setItem('isRefreshed', 'true');
        location.reload(true);
    }
</script>
    <style>
        .country-dropdown, .document-dropdown { position: absolute; z-index: 1000; width: 100%; background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-top: 0.25rem; max-height: 15rem; overflow-y: auto; }
        .country-dropdown-item, .document-dropdown-item { padding: 0.5rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; }
        .country-dropdown-item:hover, .document-dropdown-item:hover { background-color: #f3f4f6; }
        .country-dropdown-item img { width: 1.25rem; height: auto; flex-shrink: 0; }
        .dark-mode .country-dropdown, .dark-mode .document-dropdown { background-color: #374151; border-color: #4b5563; }
        .dark-mode .country-dropdown-item:hover, .dark-mode .document-dropdown-item:hover { background-color: #4b5563; }
        
        .address-dropdown { position: absolute; z-index: 30; background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-top: 0.25rem; max-height: 15rem; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .address-dropdown-item { padding: 0.5rem 1rem; cursor: pointer; white-space: nowrap; }
        .address-dropdown-item:hover { background-color: #f3f4f6; }
        .dark-mode .address-dropdown { background-color: #374151; border-color: #4b5563; }
        .dark-mode .address-dropdown-item:hover { background-color: #4b5563; }

        .input-field.is-invalid { border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); }
        .input-field:disabled { background-color: #e5e7eb; cursor: not-allowed; }
        .dark-mode .input-field:disabled { background-color: #374151; opacity: 0.6; }

        .input-indicator { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none; font-size: 1.25rem; line-height: 1; }
        .indicator-required { color: #ef4444; }
        .indicator-valid { color: #10b981; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #leave-confirm-modal { animation: fadeIn 0.2s ease-out; }

        .shipment-type-button { border: 2px solid #d1d5db; transition: all 0.2s ease; }
        .shipment-type-button.active { border-color: #f59e0b; background-color: #fefce8; }
        .dark-mode .shipment-type-button.active { border-color: #f59e0b; background-color: #453315; }
        
        .line-item, .package-piece-item { position: relative; border: 1px solid #e5e7eb; border-radius: 0.5rem; background-color: #ffffff; }
        .dark-mode .line-item, .dark-mode .package-piece-item { border-color: #4b5563; background-color: #2d3748; }
        .line-item-header, .package-piece-header { cursor: pointer; }
        .line-item-body { max-height: 1000px; overflow: hidden; transition: all 0.4s ease-in-out; opacity: 1; }
        .line-item.is-collapsed .line-item-body { max-height: 0 !important; opacity: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; border-top: none; }
        .line-item-arrow { transition: transform 0.3s ease; }
        .line-item.is-collapsed .line-item-arrow { transform: rotate(-90deg); }
        
        .line-item .line-item-summary { display: none; }
        .line-item.is-collapsed .line-item-summary { display: grid; }
        
        .dark-mode .language-dropdown { background-color: #374151; border-color: #4b5563; }
        .dark-mode .language-dropdown a:hover { background-color: #4b5563; }
        
        .dark-mode .bg-yellow-50 { background-color: #1f2937; }
        .dark-mode .input-field { background-color: #374151; }

        .file-drop-zone { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding: 1rem; border: 2px dashed #d1d5db; border-radius: 0.5rem; cursor: pointer; background-color: #f9fafb; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .file-drop-zone:hover { background-color: #f3f4f6; border-color: #fbbf24; }
        .dark-mode .file-drop-zone { background-color: #2d3748; border-color: #4b5563; }
        .dark-mode .file-drop-zone:hover { background-color: #374151; border-color: #f59e0b; }

        .uploaded-file-view { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background-color: #f9fafb; }
        .dark-mode .uploaded-file-view { background-color: #2d3748; border-color: #4b5563; }
        .delete-file-btn { background: none; border: none; cursor: pointer; color: #9ca3af; }
        .delete-file-btn:hover { color: #ef4444; }

        .noUi-target { background: #e5e7eb; border: 1px solid #d1d5db; box-shadow: none; }
        .dark-mode .noUi-target { background: #374151; border-color: #4b5563; }
        .noUi-connect { background: #6b7280; }
        .dark-mode .noUi-connect { background: #9ca3af; }
        .noUi-handle { border: 1px solid #d1d5db; border-radius: 50%; background: #fbbf24; box-shadow: none; cursor: grab; }
        .noUi-handle:active { cursor: grabbing; }
        .noUi-handle:focus { outline: none; }
        .noUi-handle::before, .noUi-handle::after { display: none; }
        .noUi-tooltip { background: #fbbf24; color: #1f2937; border: none; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; padding: 2px 6px; transform: translateY(5px); }
        
        .noUi-pips { position: relative; color: #9ca3af; }
        .dark-mode .noUi-pips { color: #6b7280; }
        .noUi-pips-horizontal { padding: 10px 0; height: 30px; top: 100%; left: 0; width: 100%; margin-top: 5px; }
        .noUi-marker-horizontal.noUi-marker { height: 8px; }
        .noUi-marker-horizontal.noUi-marker-large { height: 12px; }
        .noUi-value-horizontal { padding-top: 5px; transform: translate(-50%, 0); }
        .noUi-value-large { font-weight: 600; font-size: 0.75rem; }

        .progress-bar-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 1rem;
            margin-bottom: -1rem;
            scrollbar-width: none;
        }
        .progress-bar-container::-webkit-scrollbar {
            display: none;
        }
        .progress-bar {
            min-width: 700px;
        }
        .step-text {
            white-space: nowrap;
        }
        .error-details-list {
            text-align: left;
            margin-top: 0.75rem;
            padding-left: 1.5rem;
            list-style-type: disc;
        }
        .progress-step.is-complete {
            cursor: pointer;
        }
        .progress-step.is-disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .progress-step.is-disabled .step-circle {
            background-color: #e5e7eb;
            border-color: #d1d5db;
            color: #9ca3af;
        }
        .dark-mode .progress-step.is-disabled .step-circle {
            background-color: #374151;
            border-color: #4b5563;
        }
    </style>
</head>
<body class="with-faded-bg">
    <header class="bg-white shadow-md py-4 px-6 md:px-10 flex justify-between items-center relative z-10 rounded-b-xl">
        <a href="index.html" class="flex items-center"><span class="text-4xl font-bold text-red-600">Shipment Creation</span><span class="ml-2 text-xl font-semibold text-gray-800 sm:block">Backup Solution (Test Environment)</span></a>
        
        <!-- Desktop Nav -->
        <nav class="hidden sm:flex items-center space-x-2 sm:space-x-4">
            <button id="clear-history-btn" class="utility-button px-4 py-2 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                <span data-i18n="clearHistory"></span>
            </button>
            <div class="relative">
                <button id="language-toggle-button" class="utility-button px-4 py-2 flex items-center gap-2"><span id="current-language-display"></span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>
                <div id="language-dropdown" class="language-dropdown absolute right-0 mt-2 w-28 bg-white rounded-md shadow-lg hidden z-20">
                    <a href="#" class="block px-4 py-2" data-lang="th">ภาษาไทย</a><a href="#" class="block px-4 py-2" data-lang="en">English</a>
                </div>
            </div>
            <button id="theme-toggle" class="utility-button">
                <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </nav>

        <!-- Mobile Nav Button -->
        <div class="sm:hidden">
            <button id="mobile-menu-button" class="utility-button p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden fixed inset-0 z-40">
        <div class="fixed inset-0 bg-black bg-opacity-50" aria-hidden="true"></div>
        <div id="mobile-menu-content" class="fixed top-0 right-0 w-64 h-full bg-yellow-50 dark:bg-gray-800 shadow-lg p-6 z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-bold" data-i18n="menu"></h2>
                <button id="mobile-menu-close-button" class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-3xl">&times;</button>
            </div>
            <nav class="flex flex-col space-y-4">
                <button id="mobile-clear-history-btn" class="w-full utility-button px-4 py-2 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    <span data-i18n="clearHistory"></span>
                </button>
                <div class="relative">
                    <button id="mobile-language-toggle-button" class="w-full utility-button px-4 py-2 flex items-center justify-between gap-2">
                        <span id="mobile-current-language-display"></span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="mobile-language-dropdown" class="language-dropdown absolute right-0 mt-2 w-full bg-white rounded-md shadow-lg hidden z-20">
                        <a href="#" class="block px-4 py-2" data-lang="th">ภาษาไทย</a>
                        <a href="#" class="block px-4 py-2" data-lang="en">English</a>
                    </div>
                </div>
                <button id="mobile-theme-toggle" class="w-full utility-button px-4 py-2 flex items-center justify-center gap-2">
                    <svg id="mobile-theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="mobile-theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </nav>
        </div>
    </div>

    <main class="container py-8">
        <section id="ship-now-page" class="card max-w-5xl mx-auto">
            <h1 class="text-3xl font-extrabold text-center mb-8" data-i18n="createShipment"></h1>
            <div class="progress-bar-container">
                <div class="relative mb-8">
                    <div class="progress-bar">
                        <div id="step-1" class="progress-step"><div class="step-circle"><span class="step-number">1</span><svg class="step-check" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><p class="step-text" data-i18n="addressStep"></p></div>
                        <div class="progress-separator">&gt;</div>
                        <div id="step-2" class="progress-step"><div class="step-circle"><span class="step-number">2</span><svg class="step-check" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><p class="step-text" data-i18n="shipmentDetailsStep"></p></div>
                        <div class="progress-separator">&gt;</div>
                        <div id="step-3" class="progress-step"><div class="step-circle"><span class="step-number">3</span><svg class="step-check" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><p class="step-text" data-i18n="packageStep"></p></div>
                        <div class="progress-separator">&gt;</div>
                        <div id="step-4" class="progress-step"><div class="step-circle"><span class="step-number">4</span><svg class="step-check" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><p class="step-text" data-i18n="paymentStep"></p></div>
                        <div class="progress-separator">&gt;</div>
                        <div id="step-5" class="progress-step"><div class="step-circle"><span class="step-number">5</span><svg class="step-check" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><p class="step-text" data-i18n="docsStep"></p></div>
                        <div class="progress-separator">&gt;</div>
                        <div id="step-6" class="progress-step"><div class="step-circle"><span class="step-number">6</span><svg class="step-check" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><p class="step-text" data-i18n="pickupStep"></p></div>
                        <div class="progress-separator">&gt;</div>
                        <div id="step-7" class="progress-step"><div class="step-circle"><span class="step-number">7</span><svg class="step-check" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><p class="step-text" data-i18n="summaryStep"></p></div>
                    </div>
                </div>
            </div>
            
            <form id="ship-now-form" class="space-y-6" novalidate>
                <div id="form-message" class="p-4 rounded-md text-center hidden break-words"></div>

                <!-- Step 1: Address -->
                <div id="ship-now-step-1" class="ship-now-step space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-4">
                            <h3 class="text-xl font-semibold" data-i18n="shipperInfo"></h3>
                            <div><label for="shipper-name" class="block text-sm font-medium mb-1" data-i18n="shipperName">Name</label><div class="relative"><input type="text" id="shipper-name" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                            <div><label for="shipper-company" class="block text-sm font-medium mb-1" data-i18n="shipperCompany">Company</label><div class="relative"><input type="text" id="shipper-company" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                            <div><label for="shipper-country-input" class="block text-sm font-medium mb-1" data-i18n="shipperCountry">Country</label><div class="relative"><input type="text" id="shipper-country-input" class="input-field pr-8" autocomplete="off" required disabled><input type="hidden" id="shipper-country-value"><div id="shipper-country-dropdown" class="country-dropdown hidden"></div><span class="input-indicator indicator-required">*</span></div></div>
                            <div><label for="shipper-address1" class="block text-sm font-medium mb-1" data-i18n="shipperAddress1">Address Line 1</label><div class="relative"><input type="text" id="shipper-address1" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                            <div><label for="shipper-address2" class="block text-sm font-medium mb-1" data-i18n="shipperAddress2">Address Line 2</label><div class="relative"><input type="text" id="shipper-address2" class="input-field"></div></div>
                            <div><label for="shipper-address3" class="block text-sm font-medium mb-1" data-i18n="shipperAddress3">Address Line 3</label><div class="relative"><input type="text" id="shipper-address3" class="input-field"></div></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="relative"><label for="shipper-postalcode" class="block text-sm font-medium mb-1" data-i18n="shipperPostalCode">Postal Code</label><input type="text" id="shipper-postalcode" class="input-field"></div>
                                <div class="relative"><label for="shipper-city" class="block text-sm font-medium mb-1" data-i18n="shipperCity">City</label><div class="relative"><input type="text" id="shipper-city" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                            </div>
                            <div><label for="shipper-email" class="block text-sm font-medium mb-1" data-i18n="shipperEmail">Email Address</label><div class="relative"><input type="email" id="shipper-email" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                            <div><label for="shipper-phone" class="block text-sm font-medium mb-1" data-i18n="shipperPhone">Phone</label><div class="relative"><input type="tel" id="shipper-phone" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                            <div><label for="shipper-vat" class="block text-sm font-medium mb-1" data-i18n="shipperVat">VAT / Tax ID</label><div class="relative"><input type="text" id="shipper-vat" class="input-field"></div></div>
                        </div>
                        <div id="receiver-address-details-container" class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-4">
                            <h3 class="text-xl font-semibold" data-i18n="receiverInfo"></h3>
                            <div><label for="receiver-name" class="block text-sm font-medium mb-1" data-i18n="receiverName">Name</label><div class="relative"><input type="text" id="receiver-name" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                            <div><label for="receiver-company" class="block text-sm font-medium mb-1" data-i18n="receiverCompany">Company</label><div class="relative"><input type="text" id="receiver-company" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                            <div><label for="receiver-country-input" class="block text-sm font-medium mb-1" data-i18n="receiverCountry">Country</label><div class="relative"><input type="text" id="receiver-country-input" class="input-field pr-8" autocomplete="off" required data-i18n-placeholder="typeOrSelectCountry"><input type="hidden" id="receiver-country-value"><div id="receiver-country-dropdown" class="country-dropdown hidden"></div><span class="input-indicator indicator-required">*</span></div></div>
                            
                            <!-- Fields to be initially hidden -->
                            <div id="receiver-address1-wrapper" class="hidden"><label for="receiver-address1" class="block text-sm font-medium mb-1" data-i18n="receiverAddress1">Address Line 1</label><div class="relative"><input type="text" id="receiver-address1" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                            <div id="receiver-address2-wrapper" class="hidden"><label for="receiver-address2" class="block text-sm font-medium mb-1" data-i18n="receiverAddress2">Address Line 2</label><div class="relative"><input type="text" id="receiver-address2" class="input-field"></div></div>
                            <div id="receiver-address3-wrapper" class="hidden"><label for="receiver-address3" class="block text-sm font-medium mb-1" data-i18n="receiverAddress3">Address Line 3</label><div class="relative"><input type="text" id="receiver-address3" class="input-field"></div></div>
                            <div id="receiver-postal-city-wrapper" class="grid grid-cols-2 gap-4 hidden">
                                <div id="receiver-postalcode-container">
                                    <div class="relative"><label for="receiver-postalcode" class="block text-sm font-medium mb-1" data-i18n="receiverPostalCode">Postal Code</label><input type="text" id="receiver-postalcode" class="input-field"></div>
                                </div>
                                <div>
                                    <div class="relative"><label for="receiver-city" class="block text-sm font-medium mb-1" data-i18n="receiverCity">City</label><div class="relative"><input type="text" id="receiver-city" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                                </div>
                            </div>
                            <div id="receiver-suburb-container" class="hidden">
                                <label for="receiver-suburb" class="block text-sm font-medium mb-1" data-i18n="receiverSuburb">Suburb</label><input type="text" id="receiver-suburb" class="input-field">
                            </div>
                            <!-- End of hidden fields -->

                            <!-- START: Reordered Fields -->
                            <div><label for="receiver-email" class="block text-sm font-medium mb-1" data-i18n="receiverEmail">Email Address</label><div class="relative"><input type="email" id="receiver-email" class="input-field pr-8"><span class="input-indicator"></span></div></div>
                            <div><label for="receiver-phone" class="block text-sm font-medium mb-1" data-i18n="receiverPhone">Phone</label><div class="relative"><input type="tel" id="receiver-phone" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                            <div id="receiver-vat-wrapper" class="hidden"><label for="receiver-vat" class="block text-sm font-medium mb-1" data-i18n="receiverVat">VAT / Tax ID</label><div class="relative"><input type="text" id="receiver-vat" class="input-field"></div></div>
                            <!-- END: Reordered Fields -->
                        </div>
                    </div>
                    <div id="country-condition-alert" class="hidden p-4 rounded-md bg-yellow-100 border border-yellow-300 text-yellow-800">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.636-1.026 2.85-1.026 3.486 0l5.58 8.998c.636 1.026-.474 2.403-1.743 2.403H4.42c-1.269 0-2.379-1.377-1.743-2.403l5.58-8.998zM10 12a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p id="country-condition-text" class="text-sm font-medium"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Shipment Details -->
                <div id="ship-now-step-2" class="ship-now-step hidden space-y-6">
                    <div class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button type="button" id="ship-type-document" class="shipment-type-button p-4 rounded-lg flex flex-col items-center justify-center text-center">
                                <img src="Icon/document_rgb_black.svg" alt="Parcel Logo" class="h-10 mb-5">
								<span class="font-semibold" data-i18n="document"></span>
                            </button>
                            <button type="button" id="ship-type-package" class="shipment-type-button p-4 rounded-lg flex flex-col items-center justify-center text-center active">
                                <img src="Icon/parcel_rgb_black.svg" alt="Parcel Logo" class="h-10 mb-5">
								<span class="font-semibold" data-i18n="package"></span>
                            </button>
                        </div>
                    </div>

                    <div class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-4">
                        <label for="ship-date" class="block text-sm font-medium mb-1" data-i18n="shipmentDate">Shipment Date</label>
                        <div class="relative">
                            <input type="date" id="ship-date" class="input-field pr-8" required>
                            <span class="input-indicator indicator-required">*</span>
                        </div>
                    </div>
                    
                    <div id="document-details-container" class="hidden p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-4">
                        <div>
                            <label for="document-description-input" class="block text-sm font-medium mb-1" data-i18n="describeDocuments"></label>
                            <div class="relative">
                                <input type="text" id="document-description-input" class="input-field pr-8" autocomplete="off" required value="Documents - general business">
                                <div id="document-description-dropdown" class="document-dropdown hidden"></div>
                                <span class="input-indicator indicator-required">*</span>
                            </div>
                        </div>
                        <div class="text-left space-y-2">
                            <label for="shipment-reference-doc" class="block text-sm font-medium" data-i18n="shipmentRef"></label>
                            <div class="relative"><input type="text" id="shipment-reference-doc" class="input-field"></div>
                        </div>
                    </div>

                    <div id="package-details-container" class="space-y-4">
                        <div id="line-items-container" class="space-y-4"></div>
                        <button type="button" id="add-line-item-btn" class="w-full btn-primary btn-gray flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span data-i18n="addLineItem"></span>
                        </button>
                        
                        <div class="p-4 border-t-2 border-dashed dark:border-gray-600 mt-4 space-y-4">
                             <div class="space-y-2 text-right">
                                <div class="flex justify-end items-center gap-4"><span class="font-semibold" data-i18n="totalUnits"></span><span id="summary-total-units" class="font-bold text-lg">0</span></div>
                                <div class="flex justify-end items-center gap-4"><span class="font-semibold" data-i18n="totalWeight"></span><span id="summary-total-weight" class="font-bold text-lg">0.000 KG</span></div>
                                <div class="flex justify-end items-center gap-4"><span class="font-semibold" data-i18n="totalValue"></span><span id="summary-total-value" class="font-bold text-lg text-red-600 dark:text-amber-400">0.000 THB</span></div>
                            </div>

                            <div id="summarize-shipment-container" class="hidden text-left space-y-2">
                                 <label for="summarize-shipment" class="block text-sm font-medium">
                                     <span data-i18n="summarizeShipment"></span>
                                     <span class="block text-xs text-gray-500 dark:text-gray-400" data-i18n="shipmentDescription"></span>
                                 </label>
                                 <div class="relative"><input type="text" id="summarize-shipment" class="input-field pr-8"><span class="input-indicator indicator-required hidden">*</span></div>
                            </div>
                            
                            <div class="text-left space-y-2">
                                <label for="shipment-reference-pkg" class="block text-sm font-medium" data-i18n="shipmentRef"></label>
                                <div class="relative"><input type="text" id="shipment-reference-pkg" class="input-field"></div>
                            </div>
                        </div>

                        <div class="p-4 border-t-2 border-dashed dark:border-gray-600 space-y-4">
                            <h4 class="font-semibold text-lg text-left" data-i18n="customsInvoiceDetails"></h4>
                             <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <button type="button" id="create-invoice-btn" class="shipment-type-button p-3 rounded-lg">
                                    <span data-i18n="createInvoice"></span>
                                </button>
                                <button type="button" id="use-my-own-invoice-btn" class="shipment-type-button p-3 rounded-lg active">
                                    <span data-i18n="useMyOwnInvoice"></span>
                                </button>
                            </div>
                            
                            <div id="invoice-options-container" class="hidden">
                                <div class="border-t-2 border-dashed dark:border-gray-600 pt-4 mt-4">
                                    <div id="invoice-type-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <button type="button" id="invoice-type-proforma" class="shipment-type-button p-3 rounded-lg active">
                                            <span data-i18n="proformaInvoice"></span>
                                        </button>
                                        <button type="button" id="invoice-type-commercial" class="shipment-type-button p-3 rounded-lg">
                                            <span data-i18n="commercialInvoice"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="invoice-number-container">
                                <label id="invoice-number-label" for="invoice-number" class="block text-sm font-medium mb-1" data-i18n="invoiceNumber"></label>
                                <div class="relative">
                                    <input type="text" id="invoice-number" class="input-field pr-8">
                                    <span id="invoice-number-indicator" class="input-indicator indicator-required hidden">*</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-4">
                        <div class="flex items-center"><input type="checkbox" id="protect-shipment" class="form-checkbox h-5 w-5 text-red-600"><label for="protect-shipment" class="ml-2" data-i18n="protectShipment"></label></div>
                        <div id="insurance-value-container" class="hidden">
                            <label for="insurance-value" class="block text-sm font-medium mb-1" data-i18n="insuredValue"></label>
                            <div class="flex items-center gap-2">
                                <div class="relative w-full">
                                    <input type="text" id="insurance-value" class="input-field w-full pr-8">
                                    <span id="insurance-value-indicator" class="input-indicator indicator-required hidden">*</span>
                                </div>
                                <span id="insurance-currency" class="font-semibold whitespace-nowrap">THB</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Package -->
                <div id="ship-now-step-3" class="ship-now-step hidden space-y-4">
                    <div class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-4">
                        <h3 class="text-xl font-semibold" data-i18n="packageDetails"></h3>
                        <div id="package-pieces-container" class="space-y-4"></div>
                        <button type="button" id="add-piece-button" class="w-full btn-primary btn-gray flex items-center justify-center gap-2">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span data-i18n="addPiece"></span>
                        </button>
                    </div>
                    <div class="p-4 border-t-2 border-dashed dark:border-gray-600 mt-4 space-y-2 text-right">
                        <div class="flex justify-end items-center gap-4">
                            <span class="font-semibold" data-i18n="totalPackages"></span>
                            <span id="summary-total-packages" class="font-bold text-lg">0</span>
                        </div>
                        <div class="flex justify-end items-center gap-4">
                            <span class="font-semibold" data-i18n="totalWeightKg"></span>
                            <span id="summary-total-weight-kg" class="font-bold text-lg">0.000 KG</span>
                        </div>
                    </div>
                </div>
                <!-- Step 4: Payment -->
                <div id="ship-now-step-4" class="ship-now-step hidden space-y-4">
                    <div class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-4">
                        <h3 class="text-xl font-semibold" data-i18n="paymentStep"></h3>
                        
                        <!-- Shipper Account -->
                        <div>
                            <label for="shipper-account" class="block text-sm font-medium mb-1" data-i18n="shipperAccount">Shipper Account</label>
                            <div class="relative">
                                <input type="text" id="shipper-account" class="input-field pr-8" required pattern="[0-9]*" inputmode="numeric">
                                <span class="input-indicator indicator-required">*</span>
                            </div>
                        </div>

                        <div class="flex items-center mt-2">
                            <input type="checkbox" id="use-shipper-for-billing" class="form-checkbox h-5 w-5 text-red-600" checked>
                            <label for="use-shipper-for-billing" class="ml-2" data-i18n="useShipperForBilling"></label>
                        </div>
                        
                        <div id="billing-account-container" class="hidden">
                            <label for="billing-account" class="block text-sm font-medium mb-1" data-i18n="billingAccount">Billing Account</label>
                            <div class="relative">
                                <input type="text" id="billing-account" class="input-field pr-8" pattern="[0-9]*" inputmode="numeric">
                                <span class="input-indicator indicator-required hidden">*</span>
                            </div>
                        </div>

                        <!-- Duties & Taxes Account -->
                        <div id="duties-account-container">
                            <label for="duties-account" class="block text-sm font-medium mb-1" data-i18n="dutiesAccount">Duties & Taxes Account</label>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="receiver-pays-checkbox" class="form-checkbox h-5 w-5 text-red-600">
                                    <label for="receiver-pays-checkbox" class="ml-2" data-i18n="receiverWillPay"></label>
                                </div>
                                <div class="relative flex-grow">
                                    <input type="text" id="duties-account" class="input-field pr-8" pattern="[0-9]*" inputmode="numeric">
                                    <span class="input-indicator indicator-required hidden">*</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Incoterm -->
                        <div id="incoterm-container">
                            <label for="incoterm" class="block text-sm font-medium mb-1" data-i18n="incoterm">Incoterm</label>
                            <select id="incoterm" class="input-field" required></select>
                        </div>
                    </div>
                </div>
                <!-- Step 5: Documents -->
                <div id="ship-now-step-5" class="ship-now-step hidden space-y-4">
                    <div class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-4">
                        <h3 class="text-xl font-semibold" data-i18n="uploadCustomsDocs"></h3>
                        <p class="text-sm" data-i18n="uploadDocsDesc1"></p>
                        <p class="text-sm" data-i18n="uploadDocsDesc2"></p>
                        
                        <div class="border-t dark:border-gray-600 pt-4 mt-4">
                            <p class="text-sm font-semibold" data-i18n="uploadDocsQuestion"></p>
                            <div class="flex items-center mt-2">
                                <input type="checkbox" id="upload-documents-checkbox" class="form-checkbox h-5 w-5 text-red-600">
                                <label for="upload-documents-checkbox" class="ml-2" data-i18n="yes">Yes</label>
                            </div>
                        </div>

                        <!-- This container holds content that appears when "Yes" is checked -->
                        <div id="upload-content-container" class="hidden mt-4 space-y-4 border-t dark:border-gray-600 pt-4">

                            <!-- This section is for the "Use My Own Invoice" flow -->
                            <div id="own-invoice-upload-section" class="hidden space-y-2">
                                <p class="text-sm font-semibold" data-i18n="uploadLabelOwnInvoice"></p>
                            </div>

                            <!-- This section is for the "Create Invoice" flow -->
                            <div id="create-invoice-upload-section" class="hidden space-y-2">
                                <p class="text-sm font-semibold" data-i18n="uploadLabelCreateInvoice"></p>
                                <div class="flex items-center">
                                    <input type="checkbox" id="optional-upload-checkbox" class="form-checkbox h-5 w-5 text-red-600">
                                    <label for="optional-upload-checkbox" class="ml-2" data-i18n="uploadOptional"></label>
                                </div>
                            </div>
                            
                            <!-- This is the actual file uploader, shared by both flows -->
                            <div id="file-upload-section" class="hidden space-y-2">
                                <div id="doc-uploader-container">
                                    <label for="doc-uploader" class="file-drop-zone">
                                        <div class="flex flex-col items-center justify-center pt-5 pb-6 text-center">
                                            <img src="Icon/upload_file_rgb_black.svg" alt="Upload Icon" class="w-10 h-10 mb-3 text-gray-400">
                                            <p class="mb-2 text-sm text-gray-500 dark:text-gray-400">
                                                <span class="font-semibold" data-i18n="browseForFile"></span><span data-i18n="orDropHere"></span>
                                            </p>
                                        </div>
                                        <input type="file" id="doc-uploader" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.gif,.tiff,.tif">
                                    </label>
                                </div>
                                <div id="uploaded-file-view" class="uploaded-file-view hidden">
                                    <div class="flex items-center gap-3 truncate">
                                        <svg class="w-6 h-6 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                                        <div class="truncate">
                                            <p id="uploaded-file-name" class="text-sm font-medium truncate"></p>
                                            <p id="uploaded-file-size" class="text-xs text-gray-500 dark:text-gray-400"></p>
                                        </div>
                                    </div>
                                    <button type="button" id="delete-file-btn" class="delete-file-btn">
                                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                                    </button>
                                </div>
                                 <div class="text-center text-xs text-gray-500 dark:text-gray-400 mt-2 space-y-1">
                                    <p data-i18n="fileTypesAllowed"></p>
                                    <p data-i18n="maxFileSize"></p>
                                    <p data-i18n="fileNameEnglishOnly"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Step 6: Pickup -->
                <div id="ship-now-step-6" class="ship-now-step hidden space-y-4">
                    <div class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-4">
                        <h3 class="text-xl font-semibold" data-i18n="pickupStep"></h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button type="button" id="pickup-yes-btn" class="shipment-type-button p-4 rounded-lg flex items-center justify-center text-center gap-2 active">
                                <img src="Icon/truck_road_freight_rgb_black.svg" alt="Pickup Truck Icon" class="h-8 mb-2">
								<span class="font-semibold" data-i18n="pickupYes"></span>
                            </button>
                            <button type="button" id="pickup-no-btn" class="shipment-type-button p-4 rounded-lg flex items-center justify-center text-center gap-2">
                                <img src="Icon/cancel_rgb_black.svg" alt="Cancel Icon" class="h-8 mb-2">
								<span class="font-semibold" data-i18n="pickupNo"></span>
                            </button>
                        </div>
                    </div>

                    <div id="pickup-yes-container" class="space-y-6">
                        <div class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-4">
                            <div>
                                <label for="pickup-date" class="block text-sm font-medium mb-1" data-i18n="pickupSendingOn"></label>
                                <div class="relative">
                                    <input type="date" id="pickup-date" class="input-field">
                                </div>
                            </div>
                             <div class="pt-4 pb-6">
                                <label class="block text-sm font-medium" data-i18n="pickupWindow"></label>
                                <div id="pickup-time-slider" class="mt-4 mb-8"></div>
                                <p class="text-center text-xs text-gray-500 -mt-6" data-i18n="pickupWindowHint"></p>
                            </div>
                            <div>
                                <label for="pickup-location-select" class="block text-sm font-medium mb-1" data-i18n="pickupLocation"></label>
                                <select id="pickup-location-select" class="input-field"></select>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="pickup-weight" class="block text-sm font-medium mb-1" data-i18n="pickupTotalWeight"></label>
                                    <div class="relative">
                                    <input type="text" id="pickup-weight" class="input-field" disabled>
                                    </div>
                                </div>
                                <div>
                                    <label for="pickup-instructions" class="block text-sm font-medium mb-1" data-i18n="pickupInstructions"></label>
                                <div class="relative"><input type="text" id="pickup-instructions" class="input-field"></div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700">
                            <div id="pickup-address-display-container">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-lg font-semibold" data-i18n="pickupAddress"></h4>
                                    <button type="button" id="edit-pickup-address-btn" class="text-sm font-semibold text-red-600 hover:text-red-800 dark:text-amber-400 dark:hover:text-amber-300" data-i18n="editAddress">Edit</button>
                                </div>
                                <div id="pickup-address-display" class="text-sm space-y-1"></div>
                            </div>
                            <div id="pickup-address-edit-container" class="hidden space-y-4">
                                <div class="flex justify-between items-center mb-2">
                                     <h4 class="text-lg font-semibold" data-i18n="pickupAddress"></h4>
                                     <button type="button" id="save-pickup-address-btn" class="text-sm font-semibold text-red-600 hover:text-red-800 dark:text-amber-400 dark:hover:text-amber-300" data-i18n="saveAddress">Save</button>
                                </div>
                                <div><label for="pickup-name" class="block text-sm font-medium mb-1" data-i18n="shipperName"></label><div class="relative"><input type="text" id="pickup-name" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                                <div><label for="pickup-company" class="block text-sm font-medium mb-1" data-i18n="shipperCompany"></label><div class="relative"><input type="text" id="pickup-company" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                                <div><label for="pickup-address1" class="block text-sm font-medium mb-1" data-i18n="shipperAddress1"></label><div class="relative"><input type="text" id="pickup-address1" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                                <div><label for="pickup-address2" class="block text-sm font-medium mb-1" data-i18n="shipperAddress2">Address Line 2</label><div class="relative"><input type="text" id="pickup-address2" class="input-field"></div></div>
                                <div><label for="pickup-address3" class="block text-sm font-medium mb-1" data-i18n="shipperAddress3">Address Line 3</label><div class="relative"><input type="text" id="pickup-address3" class="input-field"></div></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="pickup-postalcode" class="block text-sm font-medium mb-1" data-i18n="shipperPostalCode"></label><input type="text" id="pickup-postalcode" class="input-field"></div>
                                    <div><label for="pickup-city" class="block text-sm font-medium mb-1" data-i18n="shipperCity"></label><div class="relative"><input type="text" id="pickup-city" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                                </div>
                                <div><label for="pickup-phone" class="block text-sm font-medium mb-1" data-i18n="shipperPhone"></label><div class="relative"><input type="tel" id="pickup-phone" class="input-field pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                            </div>
                        </div>
                    </div>

                    <div id="pickup-no-container" class="hidden text-center p-4">
                        <a href="https://www.dhl.com/discover/th-th/contact-us" target="_blank" rel="noopener noreferrer" class="text-red-600 hover:text-red-800 dark:text-amber-400 dark:hover:text-amber-300 font-semibold underline" data-i18n="pickupDropOffLink"></a>
                    </div>
                </div>

                <!-- Step 7: Summary -->
                <div id="ship-now-step-7" class="ship-now-step hidden space-y-4">
                    <div class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold" data-i18n="summary"></h3>
                            <button type="button" id="edit-summary-btn" class="text-sm font-semibold text-red-600 hover:text-red-800 dark:text-amber-400 dark:hover:text-amber-300" data-i18n="editShipment">Edit</button>
                        </div>
                        <div id="summary-details-content" class="text-sm space-y-6"></div>
                    </div>

                    <div id="print-options-container" class="p-4 border rounded-lg bg-yellow-50 dark:border-gray-700 space-y-4">
                        <h3 class="text-xl font-semibold" data-i18n="selectPrintSize">กรุณาเลือกขนาดในการปริ้น</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button type="button" id="print-size-a4" class="shipment-type-button p-4 rounded-lg flex flex-col items-center justify-center text-center">
                                <span class="font-semibold" data-i18n="printA4">ขนาด A4</span>
                            </button>
                            <button type="button" id="print-size-label" class="shipment-type-button p-4 rounded-lg flex flex-col items-center justify-center text-center">
                                <span class="font-semibold" data-i18n="printLabel">ขนาด Label</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between gap-4 mt-6">
                    <a href="index.html" id="back-to-main-btn" class="btn-primary btn-gray flex items-center justify-center whitespace-nowrap" data-i18n="backToMain"></a>
                    <button type="button" id="ship-now-prev-step" class="btn-primary btn-gray hidden" data-i18n="previous"></button>
                    <button type="button" id="ship-now-next-step" class="flex-1 btn-primary btn-yellow" data-i18n="next"></button>
                    <button type="submit" id="confirm-shipment-button" class="flex-1 btn-primary btn-red hidden" data-i18n="createShipmentBtn"></button>
                </div>
            </form>
        </section>

        <div id="leave-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-auto">
                <h2 class="text-2xl font-bold mb-4" data-i18n="leaveSiteTitle"></h2>
                <p class="text-gray-700 dark:text-gray-300 mb-6" data-i18n="leaveSiteBody"></p>
                <div class="flex justify-end gap-4">
                    <button id="stay-button" class="btn-primary btn-gray" data-i18n="stayButton"></button>
                    <button id="leave-button" class="btn-primary btn-red" data-i18n="leaveButton"></button>
                </div>
            </div>
        </div>

        <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="w-16 h-16 border-8 border-dashed rounded-full animate-spin border-yellow-400"></div>
        </div>

    </main>
        <footer>
        <div class="container mx-auto px-6 py-12">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                <div class="text-center md:text-left">
                    <h3 class="font-semibold mb-4 uppercase" data-i18n="contactSupport"></h3>
                    <ul class="space-y-2">
                        <li><a data-i18n-link="contactUs" target="_blank" class="text-sm" data-i18n="contactUs"></a></li>
                    </ul>
                </div>

                <div class="text-center md:text-left">
                    <h3 class="font-semibold mb-4 uppercase" data-i18n="legal"></h3>
                    <ul class="space-y-2">
                        <li><a data-i18n-link="termsOfUse" target="_blank" class="text-sm" data-i18n="termsOfUse"></a></li>
                        <li><a data-i18n-link="privacyNotice" target="_blank" class="text-sm" data-i18n="privacyNotice"></a></li>
                        <li><a data-i18n-link="fraudAwareness" target="_blank" class="text-sm" data-i18n="fraudAwareness"></a></li>
                        <li><a data-i18n-link="legalNotice" target="_blank" class="text-sm" data-i18n="legalNotice"></a></li>
                    </ul>
                </div>

                <div class="hidden md:block"></div>

                <div class="col-span-2 md:col-span-1 text-center md:text-left flex flex-col items-center md:items-start">
                    <img src="DHL_logo_rgb_black.svg" alt="DHL Group Logo" class="h-6 mb-5">
                    <ul class="space-y-2">
                        <li><a data-i18n-link="dhlExpress" target="_blank" class="text-sm" data-i18n="dhlExpress"></a></li>
                        <li><a data-i18n-link="aboutDhl" target="_blank" class="text-sm" data-i18n="aboutDhl"></a></li>
                        <li><a data-i18n-link="press" target="_blank" class="text-sm" data-i18n="press"></a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t mt-8 pt-6 text-center text-sm">
                &copy; <span id="current-year"></span> DHL Express. <span data-i18n="allRightsReserved"></span>
            </div>
        </div>
    </footer>

    <script src="create-shipment.js"></script>
    <script>
    let timeSlider = null; 

    document.addEventListener('DOMContentLoaded', async () => {
		if (sessionStorage.getItem('termsAccepted') !== 'true') {
            window.location.href = 'index.html';
            return;
        }
        
		// --- START: Load Static Data from JSON files ---
        let translations, countryList, currencyList, documentTypes, uomList, incotermList, pickupLocations, countryConditions, validationRules;

		function transformCountryData(apiResponse) {
            if (!apiResponse || !apiResponse.referenceData || !apiResponse.referenceData[0] || !apiResponse.referenceData[0].data) {
                console.error("Invalid country data structure from API");
                return [];
            }
            const countryDataArray = apiResponse.referenceData[0].data;
            return countryDataArray.map(countryDetails => {
                const countryObject = {};
                countryDetails.forEach(attributePair => {
                    countryObject[attributePair.attribute] = attributePair.value;
                });
                return countryObject;
            }).sort((a, b) => a.countryName.localeCompare(b.countryName)); // เรียงตามชื่อประเทศ
        }

        try {
            const [
                translationsRes,
                countriesRes,
                currenciesRes,
                docTypesRes,
                uomRes,
                incotermsRes,
                pickupLocsRes,
                appConfigRes
            ] = await Promise.all([
                fetch('data/translations.json'),
                fetch('https://sbs-back-test.vercel.app/api/address-reference?datasetName=country'),
                fetch('data/currencies.json'),
                fetch('data/documentTypes.json'),
                fetch('data/uom.json'),
                fetch('data/incoterms.json'),
                fetch('data/pickupLocations.json'),
                fetch('data/appConfig.json')
            ]);

            // Check if all fetch requests were successful
            const responses = [translationsRes, countriesRes, currenciesRes, docTypesRes, uomRes, incotermsRes, pickupLocsRes, appConfigRes];
            for (const res of responses) {
                if (!res.ok) {
                    throw new Error(`Failed to load data file: ${res.url} (${res.status})`);
                }
            }

            translations = await translationsRes.json();
            
            const rawCountryData = await countriesRes.json();
            countryList = transformCountryData(rawCountryData);
			
            currencyList = await currenciesRes.json();
            documentTypes = await docTypesRes.json();
            uomList = await uomRes.json();
            incotermList = await incotermsRes.json();
            pickupLocations = await pickupLocsRes.json();
            const appConfig = await appConfigRes.json();
            
            countryConditions = appConfig.countryConditions;
            validationRules = appConfig.validationRules;
			
            const countryOverrides = appConfig.overrideConditions || {}; // Use overrideConditions from the config file

            countryList.forEach(country => {
                if (countryOverrides[country.countryCode]) {
                    console.log(`Overriding ${country.countryCode}: From '${country.postalLocationTypeCode}' to '${countryOverrides[country.countryCode]}'`);
                    country.postalLocationTypeCode = countryOverrides[country.countryCode];
                }
            });

        } catch (error) {
            console.error("Fatal Error: Could not load initial application data.", error);
            document.body.innerHTML = `<div style="text-align: center; padding: 50px; font-family: sans-serif;"><h1>Application Error</h1><p>Could not load required configuration data. Please check the browser console for more details and try refreshing the page.</p></div>`;
            return; // Stop execution if data loading fails
        }
		 // --- END: Load Static Data ---
		 
		 // START: Logic Fix
		 function manageReceiverAddressFields(countryCode) {
            const selectedCountry = countryList.find(c => c.countryCode === countryCode);

            const postalCodeInput = document.getElementById('receiver-postalcode');
            const suburbInput = document.getElementById('receiver-suburb');
            
            const postalCodeContainer = document.getElementById('receiver-postalcode-container');
            const suburbContainer = document.getElementById('receiver-suburb-container');
            const cityContainer = document.querySelector('#receiver-city').closest('.relative').parentElement;

            if (!selectedCountry || !postalCodeContainer || !suburbContainer || !cityContainer) {
                postalCodeContainer.parentElement.classList.remove('hidden');
                postalCodeContainer.classList.remove('hidden');
                cityContainer.classList.remove('hidden');
                suburbContainer.classList.remove('hidden');
                postalCodeInput.required = true;
                suburbInput.required = false; 
                return;
            }

            // Reset fields before applying new rules
            postalCodeContainer.parentElement.classList.remove('hidden'); // Ensure grid wrapper is visible
            postalCodeContainer.classList.remove('hidden'); // Ensure postal code is visible
            cityContainer.classList.remove('hidden'); // Ensure city is visible
            suburbContainer.classList.remove('hidden'); // Ensure suburb wrapper is visible

            switch (selectedCountry.postalLocationTypeCode) {
                case 'CP': // City & Postal Code
                    suburbContainer.classList.add('hidden');
                    postalCodeInput.required = true;
                    suburbInput.required = false;
                    break;
                case 'C':  // City only
                    postalCodeContainer.classList.add('hidden'); // Hide only postal code
                    suburbContainer.classList.add('hidden');
                    postalCodeInput.required = false;
                    suburbInput.required = false;
                    break;
                case 'S':  // City & Suburb
                    postalCodeContainer.classList.add('hidden'); // Hide only postal code
                    postalCodeInput.required = false;
                    suburbInput.required = true;
                    break;
                default:   // Fallback (Show CP)
                    suburbContainer.classList.add('hidden');
                    postalCodeInput.required = true;
                    suburbInput.required = false;
                    break;
            }
        }
        // END: Logic Fix

        let currentLanguage = localStorage.getItem('language') || 'en';
        let currentStep = 1;
        const totalSteps = 7;
        let hasUnsavedChanges = false;
        let navigationTargetUrl = null;
        let lineItemCounter = 0;
        let packagePieceCounter = 0;

        function applyValidationRulesToElement(element, rules) {
            if (!element || !rules) return;
            if (rules.maxLength) element.maxLength = rules.maxLength;
            if (rules.minLength) element.minLength = rules.minLength;
            if (rules.min !== undefined) element.min = rules.min;
            if (rules.max !== undefined) element.max = rules.max;
            if (rules.length) {
                element.maxLength = rules.length;
                element.minLength = rules.length;
            }
        }

        function applyAllStaticValidationRules() {
            if (!validationRules) return;

            const fieldMap = {
                'shipper-name': validationRules.name, 'shipper-company': validationRules.company,
                'shipper-address1': validationRules.address1, 'shipper-address2': validationRules.address2, 'shipper-address3': validationRules.address3,
                'shipper-postalcode': validationRules.postalcode, 'shipper-city': validationRules.city,
                'shipper-email': validationRules.email, 'shipper-phone': validationRules.phone, 'shipper-vat': validationRules.vat,
                'receiver-name': validationRules.name, 'receiver-company': validationRules.company,
                'receiver-address1': validationRules.address1, 'receiver-address2': validationRules.address2, 'receiver-address3': validationRules.address3,
                'receiver-postalcode': validationRules.postalcode, 'receiver-city': validationRules.city, 'receiver-suburb': validationRules.suburb,
                'receiver-email': validationRules.email, 'receiver-phone': validationRules.phone, 'receiver-vat': validationRules.vat,
                'shipment-reference-doc': validationRules.shipmentRef, 'shipment-reference-pkg': validationRules.shipmentRef,
                'summarize-shipment': validationRules.summarizeShipment, 'invoice-number': validationRules.invoiceNumber,
                'shipper-account': validationRules.accountNumber, 'billing-account': validationRules.accountNumber, 'duties-account': validationRules.accountNumber,
                'pickup-name': validationRules.name, 'pickup-company': validationRules.company,
                'pickup-address1': validationRules.address1, 'pickup-address2': validationRules.address2, 'pickup-address3': validationRules.address3,
                'pickup-postalcode': validationRules.postalcode, 'pickup-city': validationRules.city,
                'pickup-phone': validationRules.phone, 'pickup-instructions': validationRules.pickupInstructions,
            };

            for (const id in fieldMap) {
                const element = document.getElementById(id);
                if (element) {
                    applyValidationRulesToElement(element, fieldMap[id]);
                }
            }
        }

        const leaveModal = document.getElementById('leave-confirm-modal');
        const stayButton = document.getElementById('stay-button');
        const leaveButton = document.getElementById('leave-button');
        const formMessage = document.getElementById('form-message');
        const packagePiecesContainer = document.getElementById('package-pieces-container');

        function getTranslatedText(key, replacements = {}) { 
            let text = translations[currentLanguage]?.[key] || key; 
            for (const placeholder in replacements) { text = text.replace(`{${placeholder}}`, replacements[placeholder]); }
            return text; 
        }
        
        function updateContentLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (el.placeholder !== undefined && (el.hasAttribute('data-i18n-placeholder') || el.matches('[data-i18n-placeholder]'))) {
                    el.placeholder = getTranslatedText(key);
                } else {
                     if (!el.closest('.line-item-summary')) {
                        el.textContent = getTranslatedText(key);
                    }
                }
            });
            
            document.querySelectorAll('[data-i18n-link]').forEach(el => {
                const key = el.getAttribute('data-i18n-link');
                const links = translations[currentLanguage]?.links;
                if (links && links[key]) {
                    el.href = links[key];
                }
            });

            document.querySelectorAll('label[data-i18n]').forEach(label => {
                const key = label.getAttribute('data-i18n');
                const asterisk = label.querySelector('.text-red-500');
                if (key !== 'invoiceNumber' && key !== 'summarizeShipment') {
                   label.innerHTML = getTranslatedText(key) + (asterisk ? ' <span class="text-red-500">*</span>' : '');
                } else if (key === 'summarizeShipment') {
                    label.innerHTML = `
                        <span data-i18n="summarizeShipment">${getTranslatedText('summarizeShipment')}</span>
                        <span class="block text-xs text-gray-500 dark:text-gray-400" data-i18n="shipmentDescription">${getTranslatedText('shipmentDescription')}</span>
                    `;
                }
                 else {
                   label.innerHTML = getTranslatedText(key);
                }
            });
            const langDisplay = document.getElementById('current-language-display');
            const mobileLangDisplay = document.getElementById('mobile-current-language-display');
            if(langDisplay) langDisplay.textContent = currentLanguage.toUpperCase();
            if(mobileLangDisplay) mobileLangDisplay.textContent = currentLanguage.toUpperCase();

            document.title = `DHL Backup Solution - ${getTranslatedText('createShipment')}`;
            document.querySelectorAll('.line-item-summary strong[data-i18n]').forEach(el => {
                 el.textContent = getTranslatedText(el.getAttribute('data-i18n'));
            });

            renumberLineItemHeaders();
            renumberPackageHeaders();
        }

        function setupTheme() {
            const themeToggles = [document.getElementById('theme-toggle'), document.getElementById('mobile-theme-toggle')];
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');            
            const mobileLightIcon = document.getElementById('mobile-theme-icon-light');
            const mobileDarkIcon = document.getElementById('mobile-theme-icon-dark');

            const toggle = () => { document.body.classList.contains('dark-mode') ? disableDarkMode() : enableDarkMode(); };
            const enableDarkMode = () => { document.body.classList.add('dark-mode'); localStorage.setItem('theme', 'dark'); if(lightIcon) lightIcon.classList.add('hidden'); if(darkIcon) darkIcon.classList.remove('hidden'); if(mobileLightIcon) mobileLightIcon.classList.add('hidden'); if(mobileDarkIcon) mobileDarkIcon.classList.remove('hidden'); };
            const disableDarkMode = () => { document.body.classList.remove('dark-mode'); localStorage.setItem('theme', 'light'); if(lightIcon) lightIcon.classList.remove('hidden'); if(darkIcon) darkIcon.classList.add('hidden'); if(mobileLightIcon) mobileLightIcon.classList.remove('hidden'); if(mobileDarkIcon) mobileDarkIcon.classList.add('hidden'); };
            
            themeToggles.forEach(btn => btn && btn.addEventListener('click', toggle));
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                enableDarkMode();
            } else {
                disableDarkMode();
            }
        }

        function setupLanguageSwitch() {
            const desktopBtn = document.getElementById('language-toggle-button');
            const mobileBtn = document.getElementById('mobile-language-toggle-button');
            const desktopDropdown = document.getElementById('language-dropdown');
            const mobileDropdown = document.getElementById('mobile-language-dropdown');

            if(desktopBtn) desktopBtn.addEventListener('click', () => desktopDropdown.classList.toggle('hidden'));
            if(mobileBtn) mobileBtn.addEventListener('click', () => mobileDropdown.classList.toggle('hidden'));

            document.querySelectorAll('[data-lang]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentLanguage = e.target.dataset.lang;
                    localStorage.setItem('language', currentLanguage);
                    updateContentLanguage();
                    checkCountryConditions(document.getElementById('receiver-country-value').value);
                    if (currentStep === 7) {
                        generateSummary();
                    }
                    if(desktopDropdown) desktopDropdown.classList.add('hidden');
                    if(mobileDropdown) mobileDropdown.classList.add('hidden');
                });
            });
        }

        function setupMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuContent = document.getElementById('mobile-menu-content');
            const openBtn = document.getElementById('mobile-menu-button');
            const closeBtn = document.getElementById('mobile-menu-close-button');

            if (!mobileMenu || !openBtn || !closeBtn || !mobileMenuContent) return;

            const openMenu = () => {
                mobileMenu.classList.remove('hidden');
                setTimeout(() => { mobileMenuContent.classList.remove('translate-x-full'); }, 10);
            };
            const closeMenu = () => {
                mobileMenuContent.classList.add('translate-x-full');
                setTimeout(() => { mobileMenu.classList.add('hidden'); }, 300);
            };
            openBtn.addEventListener('click', openMenu);
            closeBtn.addEventListener('click', closeMenu);
            mobileMenu.addEventListener('click', (e) => { if (e.target === mobileMenu) closeMenu(); });
        }
        
        function setupCountryComboBox(inputId, valueId, dropdownId, containerSelector = 'body') {
            const input = document.getElementById(inputId);
            const valueHolder = document.getElementById(valueId);
            const dropdown = document.getElementById(dropdownId);
            const container = document.querySelector(containerSelector);

            if (!input || !dropdown || !container) {
                console.error("ComboBox setup failed for:", inputId);
                return;
            }
             
            container.appendChild(dropdown);

            const positionDropdown = () => {
                const inputRect = input.getBoundingClientRect();
                if (container === document.body) {
                    // For dropdowns positioned relative to the whole page
                    dropdown.style.top = `${inputRect.bottom + window.scrollY}px`;
                    dropdown.style.left = `${inputRect.left + window.scrollX}px`;
                    dropdown.style.width = `${inputRect.width}px`;
                } else {
                    // For dropdowns inside a specific container (like a line item)
                    const containerRect = container.getBoundingClientRect();
                    dropdown.style.top = `${inputRect.bottom - containerRect.top}px`;
                    dropdown.style.left = `${inputRect.left - containerRect.left}px`;
                    dropdown.style.width = `${inputRect.width}px`;
                }
            };

            input.setAttribute('data-i18n-placeholder', 'typeOrSelectCountry');
            const renderDropdown = (filter = '') => {
                const filteredList = countryList.filter(c => c.countryName.toLowerCase().includes(filter.toLowerCase()));
                dropdown.innerHTML = filteredList.map(c => 
                    `<div class="country-dropdown-item" data-code="${c.countryCode}" data-name="${c.countryName}">
                        <img src="https://flagcdn.com/w20/${c.countryCode.toLowerCase()}.png" alt="${c.countryName} flag">
                        <span>${c.countryName}</span>
                    </div>`
                ).join('');
            };
			
            input.addEventListener('focus', () => { 
                positionDropdown();
                renderDropdown(input.value); 
                dropdown.classList.remove('hidden'); 
            });
            input.addEventListener('input', () => { 
                positionDropdown();
                renderDropdown(input.value); 
                if(valueHolder) valueHolder.value = '';
                dropdown.classList.remove('hidden'); 
                updateInputValidationState(input);
            });
            dropdown.addEventListener('click', (e) => {
                const item = e.target.closest('.country-dropdown-item');
                if (item) {
                    const prefix = inputId.split('-')[0];
                    const previousCountry = valueHolder.value;
                    const newCountry = item.dataset.code;

                    input.value = item.dataset.name;
                    if(valueHolder) valueHolder.value = newCountry;
                    dropdown.classList.add('hidden');
                    updateInputValidationState(input);

                    if (inputId.startsWith('receiver-')) {
                        if (previousCountry !== newCountry) {
                            const fieldsToClear = ['postalcode', 'city', 'suburb', 'address1', 'address2', 'address3'];
                            fieldsToClear.forEach(field => {
                                const fieldInput = document.getElementById(`${prefix}-${field}`);
                                if(fieldInput) fieldInput.value = '';
                            });
                        }
                        
                        document.getElementById('receiver-address1-wrapper').classList.remove('hidden');
                        document.getElementById('receiver-address2-wrapper').classList.remove('hidden');
                        document.getElementById('receiver-address3-wrapper').classList.remove('hidden');
                        document.getElementById('receiver-postal-city-wrapper').classList.remove('hidden');
                        document.getElementById('receiver-vat-wrapper').classList.remove('hidden');
                        
                        const addressContainer = document.getElementById('receiver-address-details-container');
                        addressContainer.querySelectorAll('input[data-was-required="true"]').forEach(field => {
                           if (!field.closest('.hidden')) {
                               field.required = true;
                           }
                        });
                        
                        checkCountryConditions(newCountry);
                        manageReceiverAddressFields(newCountry);
                    }
                }
            });
            document.addEventListener('click', (e) => { if (!input.contains(e.target) && !dropdown.contains(e.target)) { dropdown.classList.add('hidden'); } });
            window.addEventListener('resize', () => {
                 if (!dropdown.classList.contains('hidden')) {
                    positionDropdown();
                }
            });
        }
        
        function updateInputValidationState(inputElement, isInitialCheck = false) {
            // Don't validate hidden fields
            if (inputElement.offsetParent === null && inputElement.type !== 'hidden' && inputElement.type !== 'date') { return; }
            const wrapper = inputElement.closest('.relative') || inputElement.parentElement;
            if (!wrapper) return;
            const indicator = wrapper.querySelector('.input-indicator');
            const isRequired = inputElement.hasAttribute('required');
            
            let isValid = true;

            // --- Start of validation logic ---
            const maxLength = parseInt(inputElement.maxLength, 10);
            if (maxLength > 0 && inputElement.value.length > maxLength) {
                isValid = false;
            } else if (inputElement.type === 'number') {
                isValid = inputElement.checkValidity();
            } else if (inputElement.id.includes('-country-input')) {
                const valueHolderId = inputElement.id.replace('-input', '-value');
                isValid = !!document.getElementById(valueHolderId)?.value;
            } else if (inputElement.id.includes('-account')) {
                const accountRule = validationRules?.accountNumber;
                isValid = !isRequired || (accountRule && inputElement.value.length === accountRule.length);
            } else if (inputElement.type === 'email') {
                if (inputElement.value.trim() === '') {
                    isValid = !isRequired;
                } else {
                    isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(inputElement.value);
                }
            } else {
                isValid = !isRequired || inputElement.value.trim() !== '';
            }

            if (isValid && inputElement.type === 'tel' && inputElement.value.trim().length > 0 && inputElement.value.trim().length < 4) {
                isValid = false;
            }
            // --- End of validation logic ---

            // --- Start of UI update logic ---
            if (maxLength > 0) {
                manageLengthError(inputElement, maxLength);
            }

            if (isValid) {
                inputElement.classList.remove('is-invalid');
                if (indicator) {
                    indicator.textContent = isRequired ? '✓' : '';
                    indicator.classList.remove('indicator-required');
                    if (isRequired) indicator.classList.add('indicator-valid');
                }
            } else {
                // If it's an initial check and the field is just empty (but required), don't show the red border.
                if (isInitialCheck && inputElement.value.trim() === '' && isRequired) {
                    inputElement.classList.remove('is-invalid');
                } else {
                    inputElement.classList.add('is-invalid');
                }
                
                if (indicator) {
                    indicator.textContent = isRequired ? '*' : '!';
                    indicator.classList.remove('indicator-valid');
                    indicator.classList.add('indicator-required');
                }
            }
        }
        
        function setupDocumentCombobox() {
            const input = document.getElementById('document-description-input');
            const dropdown = document.getElementById('document-description-dropdown');

            const renderDropdown = (filter = '') => {
                const filteredList = documentTypes.filter(d => d.toLowerCase().includes(filter.toLowerCase()));
                dropdown.innerHTML = filteredList.map(d => `<div class="document-dropdown-item" data-value="${d}">${d}</div>`).join('');
            };

            input.addEventListener('focus', () => {
                renderDropdown(input.value);
                dropdown.classList.remove('hidden');
            });

            input.addEventListener('input', () => {
                renderDropdown(input.value);
                dropdown.classList.remove('hidden');
            });

            dropdown.addEventListener('click', (e) => {
                const item = e.target.closest('.document-dropdown-item');
                if (item) {
                    input.value = item.dataset.value;
                    dropdown.classList.add('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        }

        function populateStaticDropdowns() {
            const incotermSelect = document.getElementById('incoterm');
            if (incotermSelect) {
                incotermSelect.innerHTML = incotermList.map(item =>
                    `<option value="${item.incoterm}">${item.incoterm} - ${item.incotermName}</option>`
                ).join('');
                incotermSelect.value = 'DAP';
            }
            
            const pickupLocationSelect = document.getElementById('pickup-location-select');
            if(pickupLocationSelect) {
                pickupLocationSelect.innerHTML = pickupLocations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
            }
        }

        function checkCountryConditions(countryCode) {
            const alertBox = document.getElementById('country-condition-alert');
            const alertText = document.getElementById('country-condition-text');
            const conditionKey = countryConditions[countryCode];
            
            if (conditionKey) {
                alertText.textContent = getTranslatedText(conditionKey);
                alertBox.classList.remove('hidden');
            } else {
                alertBox.classList.add('hidden');
            }
        }

        const prevButton = document.getElementById('ship-now-prev-step');
        const nextButton = document.getElementById('ship-now-next-step');
        
        function changeStep(step) {
            document.getElementById('form-message').classList.add('hidden');
            document.getElementById('form-message').textContent = '';
            document.querySelectorAll('.ship-now-step').forEach(el => el.classList.add('hidden'));
            const stepContainer = document.getElementById(`ship-now-step-${step}`);
            stepContainer.classList.remove('hidden');
            currentStep = step;
            updateStepIndicator();
            updateNavButtons();
            
            document.getElementById('ship-now-page').scrollIntoView({ behavior: 'smooth' });

            // Re-validate all inputs in the current step to show correct indicators for default values.
            // This is crucial for fields that have default values but are on initially hidden steps.
            stepContainer.querySelectorAll('input, select').forEach(input => {
                updateInputValidationState(input, true); // Pass true for initial check
            });

            if (step === 2) {
                const lineItemsContainer = document.getElementById('line-items-container');
                // If no items exist yet, create the first one. This ensures item 1 is created
                // under the same conditions as subsequent items (i.e., when its step is visible),
                // which resolves the validation indicator issue.
                if (lineItemsContainer.children.length === 0) {
                    createLineItem();
                    updateSummary(); // Update summary after creating the first item
                }

                const firstItem = lineItemsContainer.querySelector('.line-item:first-child');
                // The first item is collapsed by default after creation, so expand it for the user.
                if (firstItem && firstItem.classList.contains('is-collapsed')) {
                    firstItem.classList.remove('is-collapsed');
                }
            }
            if (step === 5) {
                 updateDocsStepUI();
            }
            if (step === 6) {
                updatePickupStepData();
            }
            if (step === 7) {
                generateSummary();
            }
        }

        function updateNavButtons() {
            const backToMainBtn = document.getElementById('back-to-main-btn');
            const confirmButton = document.getElementById('confirm-shipment-button');
            prevButton.classList.toggle('hidden', currentStep === 1);
            nextButton.classList.toggle('hidden', currentStep === totalSteps);
            confirmButton.classList.toggle('hidden', currentStep !== totalSteps);
            backToMainBtn.classList.toggle('hidden', currentStep !== 1);
            nextButton.classList.toggle('w-full', currentStep === 1);
            nextButton.classList.toggle('flex-1', currentStep > 1 && currentStep < totalSteps);
            prevButton.classList.toggle('flex-1', currentStep > 1);
        }

        function updateStepIndicator() {
            const separators = document.querySelectorAll('.progress-separator');
            const isDocument = document.getElementById('ship-type-document').classList.contains('active');
            
            for (let i = 1; i <= totalSteps; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                stepEl.classList.remove('is-active', 'is-complete', 'is-disabled');

                if (i === 5 && isDocument) { // Disable docs step for documents
                    stepEl.classList.add('is-disabled');
                }

                if (i === currentStep) {
                    stepEl.classList.add('is-active');
                } else if (i < currentStep) {
                    stepEl.classList.add('is-complete');
                }
                
                if (i <= separators.length) {
                    const separatorEl = separators[i - 1];
                    if (i < currentStep) {
                        separatorEl.classList.add('is-complete');
                    } else {
                        separatorEl.classList.remove('is-complete');
                    }
                }
            }
        }

        function validateCurrentStep() {
            let isValid = true;
            let firstInvalidElement = null;
            let errorMessage = getTranslatedText('fillAllFields');
            const stepDiv = document.getElementById(`ship-now-step-${currentStep}`);

            // Determine which inputs to validate for the current step
            let inputsToValidate;
            if (currentStep === 2) {
                const isDocument = document.getElementById('ship-type-document').classList.contains('active');
                if (isDocument) {
                    inputsToValidate = Array.from(stepDiv.querySelectorAll('#document-details-container input[required], #ship-date'));
                } else {
                    inputsToValidate = Array.from(stepDiv.querySelectorAll('#package-details-container input[required], #package-details-container select[required], #ship-date'));
                }
            } else {
                inputsToValidate = Array.from(stepDiv.querySelectorAll('input[required]:not(:disabled), select[required]:not(:disabled)'));
            }

            // Also check optional emails and fields with maxlength if they have content
            stepDiv.querySelectorAll('input[type="email"]:not([required]), input[maxlength]:not([required])').forEach(input => {
                if (input.value.trim() !== '') {
                    inputsToValidate.push(input);
                }
            });

            // Validate all collected fields
            inputsToValidate.forEach(input => {
                updateInputValidationState(input);
                if (isValid) {
                    if (input.classList.contains('is-invalid')) {
                        isValid = false;
                        if (!firstInvalidElement) firstInvalidElement = input;
                    }
                }
            });

            // --- START: Custom validation for specific steps ---
            if (currentStep === 3) {
                let totalPackages = 0;
                stepDiv.querySelectorAll('.piece-quantity').forEach(input => {
                    totalPackages += parseInt(input.value, 10) || 0;
                });
                if (totalPackages > 99) {
                    isValid = false;
                    errorMessage = getTranslatedText('totalPackagesMaxError', { max: 99 });
                    stepDiv.querySelectorAll('.piece-quantity').forEach(input => {
                        input.classList.add('is-invalid');
                        if (!firstInvalidElement) firstInvalidElement = input;
                    });
                }
            }
            if (currentStep === 6) {
                const pickupEditContainer = document.getElementById('pickup-address-edit-container');
                if (pickupEditContainer && !pickupEditContainer.classList.contains('hidden')) {
                    isValid = false;
                    errorMessage = getTranslatedText('savePickupAddressError');
                    if (!firstInvalidElement) firstInvalidElement = document.getElementById('save-pickup-address-btn');
                }
            }
            // --- END: Custom validation for specific steps ---

            formMessage.classList.toggle('hidden', isValid);
            if (!isValid) {
                formMessage.textContent = errorMessage;
                formMessage.className = 'p-4 rounded-md text-center bg-red-100 text-red-700 break-words';
                document.getElementById('ship-now-page').scrollIntoView({ behavior: 'smooth' });
            }
            return isValid;
        }


        const lineItemsContainer = document.getElementById('line-items-container');
        const packageDetailsContainer = document.getElementById('package-details-container');
        const documentDetailsContainer = document.getElementById('document-details-container');
        const insuranceValueContainer = document.getElementById('insurance-value-container');
        const summarizeShipmentContainer = document.getElementById('summarize-shipment-container');

        function renumberLineItemHeaders() {
            const headers = lineItemsContainer.querySelectorAll('.line-item-header h4');
            const summarizeInput = document.getElementById('summarize-shipment');
            const summarizeIndicator = document.querySelector('#summarize-shipment-container .input-indicator');
            
            headers.forEach((header, index) => {
                header.textContent = `${getTranslatedText('itemHeader')} #${index + 1}`;
            });
            
            const showSummarize = headers.length > 1;
            summarizeShipmentContainer.classList.toggle('hidden', !showSummarize);
            summarizeInput.required = showSummarize;

            if (summarizeIndicator) {
                summarizeIndicator.classList.toggle('hidden', !showSummarize);
            }
        }
        
        function createLineItem() {
            lineItemCounter++;
            const itemId = lineItemCounter;
            const currencyOptions = currencyList.map(c => `<option value="${c}" ${c === 'THB' ? 'selected' : ''}>${c}</option>`).join('');
            const unitOptions = uomList.map(u => `<option value="${u.unitOfMeasurement}" ${u.unitOfMeasurement === 'PCS' ? 'selected' : ''}>${u.description}</option>`).join('');

            const itemHTML = `
                <div class="line-item" id="item-wrapper-${itemId}">
                    <div class="line-item-header flex justify-between items-center p-4">
                        <div>
                            <h4 class="font-bold text-lg">${getTranslatedText('itemHeader')} #${itemId}</h4>
                            <div class="line-item-summary text-sm text-gray-500 dark:text-gray-400 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-4 gap-y-1 mt-2">
                                <div class="truncate"><strong data-i18n="itemDescription" class="font-semibold text-current"></strong>: <span class="summary-description">...</span></div>
                                <div><strong data-i18n="quantity" class="font-semibold text-current"></strong>: <span class="summary-quantity">...</span></div>
                                <div><strong data-i18n="totalWeight" class="font-semibold text-current"></strong>: <span class="summary-weight">...</span></div>
                                <div><strong data-i18n="totalItemValue" class="font-semibold text-current"></strong>: <span class="summary-value font-semibold">...</span></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button type="button" class="delete-item-btn text-gray-400 hover:text-red-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                            <div class="line-item-arrow p-1">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="line-item-body p-4 space-y-4 border-t border-gray-200 dark:border-gray-700 mt-4">
                        <div><label class="block text-sm font-medium mb-1" data-i18n="whatIsTheItem"></label><div class="relative"><input type="text" class="input-field item-description pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                        <div><label class="block text-sm font-medium mb-1" data-i18n="commodityCode"></label><input type="text" class="input-field commodity-code" placeholder="xxxx.xx.xxxxxx"></div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label class="block text-sm font-medium mb-1" data-i18n="quantity"></label><div class="relative"><input type="number" step="1" value="1" class="input-field item-quantity pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                            <div><label class="block text-sm font-medium mb-1" data-i18n="units"></label><select class="input-field item-units">${unitOptions}</select></div>
                            <div><label class="block text-sm font-medium mb-1" data-i18n="weight"></label><div class="relative"><input type="number" step="0.001" value="0.5" class="input-field item-weight pr-8" required><span class="input-indicator indicator-required">*</span></div></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1" data-i18n="valuePerItem"></label>
                                <div class="flex items-center">
                                    <div class="relative w-full"><input type="number" step="0.001" value="1" class="input-field item-value rounded-r-none pr-8" required><span class="input-indicator indicator-required">*</span></div>
                                    <select class="input-field item-currency rounded-l-none border-l-0 w-24">${currencyOptions}</select>
                                </div>
                            </div>
                            <div class="relative">
                                <label class="block text-sm font-medium mb-1" data-i18n="whereWasItMade"></label>
                                <div class="relative">
                                    <input type="text" id="item-made-in-input-${itemId}" class="input-field item-made-in-input pr-8" autocomplete="off" required>
                                    <input type="hidden" id="item-made-in-value-${itemId}" class="item-made-in-value">
                                    <div id="item-made-in-dropdown-${itemId}" class="country-dropdown hidden"></div>
                                    <span class="input-indicator indicator-required">*</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            lineItemsContainer.insertAdjacentHTML('beforeend', itemHTML);
            const newItem = document.getElementById(`item-wrapper-${itemId}`);
            
            const lineItemRules = validationRules.lineItem;
            if (lineItemRules) {
                applyValidationRulesToElement(newItem.querySelector('.item-quantity'), lineItemRules.quantity);
                applyValidationRulesToElement(newItem.querySelector('.item-weight'), lineItemRules.weight);
                applyValidationRulesToElement(newItem.querySelector('.item-value'), lineItemRules.value);
            }
            if (validationRules.itemDescription) {
                applyValidationRulesToElement(newItem.querySelector('.item-description'), validationRules.itemDescription);
            }
            
            // Set default "Made In" country to Thailand
            const thailand = countryList.find(c => c.countryCode === 'TH');
            if (thailand) {
                const madeInInput = newItem.querySelector(`#item-made-in-input-${itemId}`);
                const madeInValue = newItem.querySelector(`#item-made-in-value-${itemId}`);
                madeInInput.value = thailand.countryName;
                madeInValue.value = thailand.countryCode;
            }
            
            // Setup the combobox for the new line item, appending dropdown to the item wrapper itself
            setupCountryComboBox(`item-made-in-input-${itemId}`, `item-made-in-value-${itemId}`, `item-made-in-dropdown-${itemId}`);

            updateLineItemSummary(newItem);
            updateContentLanguage();
            renumberLineItemHeaders();

            // Validate all inputs within the new item to show correct indicators for default values.
            // Explicitly validate fields that have default values.
            updateInputValidationState(newItem.querySelector('.item-quantity'), true);
            updateInputValidationState(newItem.querySelector('.item-weight'), true);
            updateInputValidationState(newItem.querySelector('.item-value'), true);
            updateInputValidationState(newItem.querySelector('.item-made-in-input'), true);

            newItem.classList.add('is-collapsed');
        }
        function validateLastLineItem() {
            const lastItem = lineItemsContainer.querySelector('.line-item:last-child');
            if (!lastItem) return true;
            let isLastItemValid = true;
            const requiredInputs = lastItem.querySelectorAll('input[required], select[required]');
            requiredInputs.forEach(input => {
                updateInputValidationState(input);
                if(input.classList.contains('is-invalid')) {
                    isLastItemValid = false;
                }
            });
            return isLastItemValid;
        }
        
        function updateLineItemSummary(itemElement) {
            const summaryDiv = itemElement.querySelector('.line-item-summary');
            if (!summaryDiv) return;
            const descSpan = summaryDiv.querySelector('.summary-description');
            const qtySpan = summaryDiv.querySelector('.summary-quantity');
            const weightSpan = summaryDiv.querySelector('.summary-weight');
            const valSpan = summaryDiv.querySelector('.summary-value');

            const description = itemElement.querySelector('.item-description').value;
            const quantity = itemElement.querySelector('.item-quantity').value;
            const weight = parseFloat(itemElement.querySelector('.item-weight').value) || 0;
            const value = parseFloat(itemElement.querySelector('.item-value').value) || 0;
            const currency = itemElement.querySelector('.item-currency').value;
            const totalItemWeight = (quantity * weight).toFixed(3);
            const totalValue = (quantity * value).toFixed(3);
            
            descSpan.textContent = description || '...';
            qtySpan.textContent = quantity;
            weightSpan.textContent = `${totalItemWeight} KG`;
            valSpan.textContent = `${totalValue} ${currency}`;
        }

        function updateAllLineItemSummaries() {
            document.querySelectorAll('.line-item').forEach(updateLineItemSummary);
        }

        function updateSummary() {
            let totalUnits = 0;
            let totalWeight = 0;
            let totalValue = 0;
            const currency = document.querySelector('.item-currency')?.value || 'THB';

            document.querySelectorAll('.line-item').forEach(item => {
                const quantity = parseInt(item.querySelector('.item-quantity')?.value, 10) || 0;
                const weight = parseFloat(item.querySelector('.item-weight')?.value) || 0;
                const value = parseFloat(item.querySelector('.item-value')?.value) || 0;
                totalUnits += quantity;
                totalWeight += weight * quantity;
                totalValue += value * quantity;
            });

            document.getElementById('summary-total-units').textContent = totalUnits;
            document.getElementById('summary-total-weight').textContent = `${totalWeight.toFixed(3)} KG`;
            document.getElementById('summary-total-value').textContent = `${totalValue.toFixed(3)} ${currency}`;
            
            const insuranceInput = document.getElementById('insurance-value');
            const protectShipmentCheckbox = document.getElementById('protect-shipment');
            if (protectShipmentCheckbox.checked) {
                insuranceInput.value = totalValue.toFixed(3);
            }

            updateAllLineItemSummaries();
        }

        document.getElementById('add-line-item-btn').addEventListener('click', () => {
            const lastItem = lineItemsContainer.querySelector('.line-item:last-child');

            if (validateLastLineItem()) {
                // ถ้า line item สุดท้ายถูกต้อง ให้ยุบ (collapse) ก่อนที่จะเพิ่มอันใหม่
                if (lastItem && !lastItem.classList.contains('is-collapsed')) {
                    lastItem.classList.add('is-collapsed');
                }
                
                formMessage.classList.add('hidden');
                createLineItem();
                updateSummary();
                const newItem = lineItemsContainer.querySelector('.line-item:last-child');
                if (newItem) {
                    newItem.classList.remove('is-collapsed');
                }
            } else {
                // ถ้า line item สุดท้ายไม่ถูกต้อง ให้เปิดค้างไว้ (expand) เพื่อให้เห็น error
                if (lastItem) {
                    lastItem.classList.remove('is-collapsed');
                }
                formMessage.textContent = getTranslatedText('fillAllFieldsInItem');
                formMessage.className = 'p-4 rounded-md text-center bg-red-100 text-red-700 break-words';
                formMessage.classList.remove('hidden');
            }
        });

        lineItemsContainer.addEventListener('click', (e) => {
            const itemWrapper = e.target.closest('.line-item');
            if (!itemWrapper) return;

            if (e.target.closest('.delete-item-btn')) {
                itemWrapper.remove();
                renumberLineItemHeaders();
                updateSummary();
            } else if (e.target.closest('.line-item-header')) {
                itemWrapper.classList.toggle('is-collapsed');
            }
        });

        lineItemsContainer.addEventListener('input', (e) => {
            const target = e.target;
            const item = target.closest('.line-item');
            if (item) {
                updateLineItemSummary(item);
            }
            if (target.matches('.item-quantity, .item-weight, .item-value, .item-currency')) {
                updateSummary();
            }
            if (target.matches('.item-currency')) {
                const newCurrency = target.value;
                document.querySelectorAll('.item-currency').forEach(select => select.value = newCurrency);
                document.getElementById('insurance-currency').textContent = newCurrency;
            }
            if (target.matches('.commodity-code')) {
                let val = target.value.replace(/[^\d]/g, '');
                if (val.length > 4) val = val.slice(0, 4) + '.' + val.slice(4);
                if (val.length > 7) val = val.slice(0, 7) + '.' + val.slice(7);
                target.value = val.slice(0, 14);
            }
            if (target.matches('.item-quantity')) {
                target.value = target.value.replace(/\D/g, '');
            }
            if (target.matches('.item-weight, .item-value')) {
                const value = target.value;
                const decimalIndex = value.indexOf('.');
                if (decimalIndex !== -1 && value.length - decimalIndex - 1 > 3) {
                    target.value = value.substring(0, decimalIndex + 4);
                }
            }
        });

        const docDescInput = document.getElementById('document-description-input');
        const incotermContainer = document.getElementById('incoterm-container');
        const incotermSelect = document.getElementById('incoterm');
        const dutiesAccountContainer = document.getElementById('duties-account-container');

        document.getElementById('ship-type-document').addEventListener('click', (e) => {
            e.currentTarget.classList.add('active');
            document.getElementById('ship-type-package').classList.remove('active');
            packageDetailsContainer.classList.add('hidden');
            documentDetailsContainer.classList.remove('hidden');
            insuranceValueContainer.classList.add('hidden');
            document.getElementById('insurance-value').required = false;
            docDescInput.required = true;
            
            dutiesAccountContainer.classList.add('hidden');
            incotermContainer.classList.add('hidden');
            incotermSelect.required = false;
            updateStepIndicator();
            updateInputValidationState(docDescInput, true);
        });

        document.getElementById('ship-type-package').addEventListener('click', (e) => {
            e.currentTarget.classList.add('active');
            document.getElementById('ship-type-document').classList.remove('active');
            packageDetailsContainer.classList.remove('hidden');
            documentDetailsContainer.classList.add('hidden');
            if (document.getElementById('protect-shipment').checked) {
                insuranceValueContainer.classList.remove('hidden');
                document.getElementById('insurance-value').required = true;
            }
            docDescInput.required = false;

            dutiesAccountContainer.classList.remove('hidden');
            incotermContainer.classList.remove('hidden');
            incotermSelect.required = true;
            updateStepIndicator();
        });
        
        document.getElementById('protect-shipment').addEventListener('change', (e) => {
            const isPackage = document.getElementById('ship-type-package').classList.contains('active');
            const insuranceInput = document.getElementById('insurance-value');
            const insuranceIndicator = document.getElementById('insurance-value-indicator');
            const isChecked = e.target.checked;

            if (isPackage) {
                insuranceValueContainer.classList.toggle('hidden', !isChecked);
                insuranceInput.required = isChecked;
                insuranceIndicator.classList.toggle('hidden', !isChecked);
                
                if (isChecked) {
                    updateSummary();
                    insuranceInput.disabled = true;
                } else {
                    insuranceInput.disabled = false;
                    insuranceInput.value = '';
                }
            }
        });
        
        const createInvoiceBtn = document.getElementById('create-invoice-btn');
        const useMyOwnInvoiceBtn = document.getElementById('use-my-own-invoice-btn');
        const invoiceOptionsContainer = document.getElementById('invoice-options-container');
        const invoiceNumberContainer = document.getElementById('invoice-number-container');
        const invoiceNumberInput = document.getElementById('invoice-number');
        const invoiceNumberIndicator = document.getElementById('invoice-number-indicator');

        function updateDocsStepUI() {
            const mainUploadCheckbox = document.getElementById('upload-documents-checkbox');
            const uploadContentContainer = document.getElementById('upload-content-container');
            
            if (!mainUploadCheckbox.checked) {
                uploadContentContainer.classList.add('hidden');
                // Ensure everything inside is hidden and reset
                document.getElementById('optional-upload-checkbox').checked = false;
                document.getElementById('file-upload-section').classList.add('hidden');
                document.getElementById('doc-uploader').required = false;
                return;
            }

            uploadContentContainer.classList.remove('hidden');

            const isOwnInvoice = useMyOwnInvoiceBtn.classList.contains('active');
            const ownInvoiceSection = document.getElementById('own-invoice-upload-section');
            const createInvoiceSection = document.getElementById('create-invoice-upload-section');
            const fileUploadSection = document.getElementById('file-upload-section');
            const optionalUploadCheckbox = document.getElementById('optional-upload-checkbox');
            const docUploader = document.getElementById('doc-uploader');
            
            ownInvoiceSection.classList.toggle('hidden', !isOwnInvoice);
            createInvoiceSection.classList.toggle('hidden', isOwnInvoice);

            let showUploader = false;
            if (isOwnInvoice) {
                showUploader = true;
            } else {
                showUploader = optionalUploadCheckbox.checked;
            }

            fileUploadSection.classList.toggle('hidden', !showUploader);
            docUploader.required = showUploader;

            if (!showUploader && docUploader.files.length > 0) {
                docUploader.value = '';
                docUploader.dispatchEvent(new Event('change'));
            }
        }

        function updateInvoiceSection() {
            const isPackage = document.getElementById('ship-type-package').classList.contains('active');
            if (!isPackage) return;
            
            invoiceNumberContainer.classList.remove('hidden');
            invoiceNumberInput.required = true;
            invoiceNumberIndicator.classList.remove('hidden');
        }

        createInvoiceBtn.addEventListener('click', (e) => {
            e.currentTarget.classList.add('active');
            useMyOwnInvoiceBtn.classList.remove('active');
            invoiceOptionsContainer.classList.remove('hidden');
            updateInvoiceSection();
        });

        useMyOwnInvoiceBtn.addEventListener('click', (e) => {
            e.currentTarget.classList.add('active');
            createInvoiceBtn.classList.remove('active');
            invoiceOptionsContainer.classList.add('hidden');
            updateInvoiceSection();
        });

        document.getElementById('invoice-type-proforma').addEventListener('click', (e) => {
            e.currentTarget.classList.add('active');
            document.getElementById('invoice-type-commercial').classList.remove('active');
        });

        document.getElementById('invoice-type-commercial').addEventListener('click', (e) => {
            e.currentTarget.classList.add('active');
            document.getElementById('invoice-type-proforma').classList.remove('active');
        });

        function updatePackageSummary() {
            let totalPackages = 0;
            let totalWeight = 0;
            document.querySelectorAll('.package-piece-item').forEach(piece => {
                const quantity = parseInt(piece.querySelector('.piece-quantity')?.value, 10) || 0;
                const weight = parseFloat(piece.querySelector('.piece-weight')?.value) || 0;
                totalPackages += quantity;
                totalWeight += weight * quantity;
            });
            document.getElementById('summary-total-packages').textContent = totalPackages;
            const totalWeightKgString = `${totalWeight.toFixed(3)} KG`;
            document.getElementById('summary-total-weight-kg').textContent = totalWeightKgString;

            const pickupWeightInput = document.getElementById('pickup-weight');
            if (pickupWeightInput) {
                pickupWeightInput.value = totalWeightKgString;
            }

            const addPieceBtn = document.getElementById('add-piece-button');
            const pieceItems = document.querySelectorAll('#package-pieces-container .package-piece-item');
            addPieceBtn.disabled = pieceItems.length >= 999;
        }

        function renumberPackageHeaders() {
            const headers = packagePiecesContainer.querySelectorAll('.package-piece-header h4');
            headers.forEach((header, index) => {
                header.textContent = `${getTranslatedText('package')} #${index + 1}`;
            });
        }

        function createPackagePiece() {
            packagePieceCounter++;
            const pieceId = packagePieceCounter;
            const pieceHTML = `
                <div class="package-piece-item p-4" id="piece-wrapper-${pieceId}">
                    <div class="package-piece-header flex justify-between items-center mb-4">
                        <h4 class="font-bold text-lg">${getTranslatedText('package')} #${pieceId}</h4>
                        <button type="button" class="delete-piece-btn text-gray-400 hover:text-red-500 ${pieceId === 1 ? 'hidden' : ''}">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1" data-i18n="quantity"></label>
                                <div class="relative"><input type="number" step="1" value="1" class="input-field piece-quantity pr-8" required placeholder="1"><span class="input-indicator indicator-required">*</span></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1" data-i18n="weightKg"></label>
                                <div class="relative"><input type="number" step="0.001" class="input-field piece-weight pr-8" required placeholder="0.000"><span class="input-indicator indicator-required">*</span></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1" data-i18n="lengthCm"></label>
                                <div class="relative"><input type="number" step="0.001" class="input-field piece-length pr-8" required placeholder="0.000"><span class="input-indicator indicator-required">*</span></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1" data-i18n="widthCm"></label>
                                <div class="relative"><input type="number" step="0.001" class="input-field piece-width pr-8" required placeholder="0.000"><span class="input-indicator indicator-required">*</span></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1" data-i18n="heightCm"></label>
                                <div class="relative"><input type="number" step="0.001" class="input-field piece-height pr-8" required placeholder="0.000"><span class="input-indicator indicator-required">*</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            packagePiecesContainer.insertAdjacentHTML('beforeend', pieceHTML);
            const newPiece = document.getElementById(`piece-wrapper-${pieceId}`);

            const packageRules = validationRules.package;
            if (packageRules) {
                applyValidationRulesToElement(newPiece.querySelector('.piece-quantity'), packageRules.quantity);
                applyValidationRulesToElement(newPiece.querySelector('.piece-weight'), packageRules.weight);
                applyValidationRulesToElement(newPiece.querySelector('.piece-length'), packageRules.dimensions);
                applyValidationRulesToElement(newPiece.querySelector('.piece-width'), packageRules.dimensions);
                applyValidationRulesToElement(newPiece.querySelector('.piece-height'), packageRules.dimensions);
            }

            updateContentLanguage();
            updatePackageSummary();

            // Validate all inputs within the new piece to show correct indicators for default values
            newPiece.querySelectorAll('input').forEach(input => {
                updateInputValidationState(input, true); // Pass true for initial check
            });
        }

        function validateLastPackagePiece() {
            const lastPiece = packagePiecesContainer.querySelector('.package-piece-item:last-child');
            if (!lastPiece) return true;
            let isLastPieceValid = true;
            const requiredInputs = lastPiece.querySelectorAll('input[required]');
            requiredInputs.forEach(input => {
                updateInputValidationState(input);
                if (input.classList.contains('is-invalid')) {
                    isLastPieceValid = false;
                }
            });
            return isLastPieceValid;
        }
        
        document.getElementById('add-piece-button').addEventListener('click', () => {
            if (validateLastPackagePiece()) {
                formMessage.classList.add('hidden');
                createPackagePiece();
            } else {
                formMessage.textContent = getTranslatedText('fillAllFieldsInPiece');
                formMessage.className = 'p-4 rounded-md text-center bg-red-100 text-red-700 break-words';
                formMessage.classList.remove('hidden');
            }
        });

        packagePiecesContainer.addEventListener('click', e => {
            if (e.target.closest('.delete-piece-btn')) {
                e.target.closest('.package-piece-item').remove();
                renumberPackageHeaders();
                updatePackageSummary();
            }
        });

        packagePiecesContainer.addEventListener('input', e => {
            const target = e.target;
            if (target.matches('.piece-quantity, .piece-weight')) {
                updatePackageSummary();
            }
            if (target.matches('.piece-quantity')) {
                target.value = target.value.replace(/[^0-9]/g, '');
            } else if (target.matches('.piece-weight, .piece-length, .piece-width, .piece-height')) {
                const value = target.value;
                const decimalIndex = value.indexOf('.');
                if (decimalIndex !== -1 && value.length - decimalIndex - 1 > 3) {
                    target.value = value.substring(0, decimalIndex + 4);
                }
            }
        });

        const receiverPaysCheckbox = document.getElementById('receiver-pays-checkbox');
        const dutiesAccountInput = document.getElementById('duties-account');
        const dutiesAccountIndicator = dutiesAccountInput.nextElementSibling;

        receiverPaysCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            dutiesAccountInput.disabled = isChecked;
            dutiesAccountInput.required = !isChecked;
            dutiesAccountIndicator.classList.toggle('hidden', isChecked);

            if (isChecked) {
                dutiesAccountInput.value = '';
                dutiesAccountInput.classList.remove('is-invalid');
            }
        });

        const useShipperForBillingCheckbox = document.getElementById('use-shipper-for-billing');
        const billingAccountContainer = document.getElementById('billing-account-container');
        const billingAccountInput = document.getElementById('billing-account');
        const billingAccountIndicator = billingAccountContainer.querySelector('.input-indicator');

        useShipperForBillingCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            billingAccountContainer.classList.toggle('hidden', isChecked);
            billingAccountInput.required = !isChecked;
            billingAccountIndicator.classList.toggle('hidden', isChecked);
            if (isChecked) {
                billingAccountInput.value = '';
                billingAccountInput.classList.remove('is-invalid');
            }
        });


        const uploadDocsCheckbox = document.getElementById('upload-documents-checkbox');
        const optionalUploadCheckbox = document.getElementById('optional-upload-checkbox');
        const docUploaderInput = document.getElementById('doc-uploader');
        const uploadedFileView = document.getElementById('uploaded-file-view');
        const uploadedFileName = document.getElementById('uploaded-file-name');
        const uploadedFileSize = document.getElementById('uploaded-file-size');
        const deleteFileBtn = document.getElementById('delete-file-btn');

        uploadDocsCheckbox.addEventListener('change', updateDocsStepUI);
        optionalUploadCheckbox.addEventListener('change', updateDocsStepUI);

        docUploaderInput.addEventListener('change', () => {
            const docUploaderContainer = document.getElementById('doc-uploader-container');
            if (docUploaderInput.files.length > 0) {
                const file = docUploaderInput.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2) + ' KB';
                const englishFileNameRegex = /^[A-Za-z0-9\s._-]+$/;
                
                if (!englishFileNameRegex.test(fileName)) {
                    formMessage.textContent = getTranslatedText('fileNameEnglishOnly');
                    formMessage.className = 'p-4 rounded-md text-center bg-red-100 text-red-700 break-words';
                    formMessage.classList.remove('hidden');
                    docUploaderInput.value = '';
                    return;
                }
                
                uploadedFileName.textContent = fileName;
                uploadedFileSize.textContent = fileSize;
                docUploaderContainer.classList.add('hidden');
                uploadedFileView.classList.remove('hidden');
                formMessage.classList.add('hidden');
            } else {
                docUploaderContainer.classList.remove('hidden');
                uploadedFileView.classList.add('hidden');
            }
        });

        deleteFileBtn.addEventListener('click', () => {
            docUploaderInput.value = '';
            docUploaderInput.dispatchEvent(new Event('change'));
        });
        
        const pickupYesBtn = document.getElementById('pickup-yes-btn');
        const pickupNoBtn = document.getElementById('pickup-no-btn');
        const pickupYesContainer = document.getElementById('pickup-yes-container');
        const pickupNoContainer = document.getElementById('pickup-no-container');
        const pickupDateInput = document.getElementById('pickup-date');
        const editPickupAddressBtn = document.getElementById('edit-pickup-address-btn');
        const savePickupAddressBtn = document.getElementById('save-pickup-address-btn');
        const pickupAddressDisplayContainer = document.getElementById('pickup-address-display-container');
        const pickupAddressEditContainer = document.getElementById('pickup-address-edit-container');
        const pickupWeightInput = document.getElementById('pickup-weight');

        pickupYesBtn.addEventListener('click', () => {
            pickupYesBtn.classList.add('active');
            pickupNoBtn.classList.remove('active');
            pickupYesContainer.classList.remove('hidden');
            pickupNoContainer.classList.add('hidden');
            pickupWeightInput.required = true;
        });

        pickupNoBtn.addEventListener('click', () => {
            pickupNoBtn.classList.add('active');
            pickupYesBtn.classList.remove('active');
            pickupNoContainer.classList.remove('hidden');
            pickupYesContainer.classList.add('hidden');
        });

        editPickupAddressBtn.addEventListener('click', () => {
            pickupAddressDisplayContainer.classList.add('hidden');
            pickupAddressEditContainer.classList.remove('hidden');
            pickupAddressEditContainer.querySelectorAll('input').forEach(input => {
                updateInputValidationState(input);
            });
        });

        savePickupAddressBtn.addEventListener('click', () => {
            let isPickupAddressValid = true;
            const fieldsToValidate = pickupAddressEditContainer.querySelectorAll('input[required]');
            fieldsToValidate.forEach(input => {
                updateInputValidationState(input);
                if (input.classList.contains('is-invalid')) {
                    isPickupAddressValid = false;
                }
            });

            if (!isPickupAddressValid) {
                return;
            }

            pickupAddressDisplayContainer.classList.remove('hidden');
            pickupAddressEditContainer.classList.add('hidden');
            const name = document.getElementById('pickup-name').value;
            const company = document.getElementById('pickup-company').value;
            const phone = document.getElementById('pickup-phone').value;
            const address1 = document.getElementById('pickup-address1').value;
            const address2 = document.getElementById('pickup-address2').value;
            const address3 = document.getElementById('pickup-address3').value;
            const city = document.getElementById('pickup-city').value;
            const postal = document.getElementById('pickup-postalcode').value;
            
            const addressHTML = `
                <p class="break-words"><strong>${name}</strong>, ${company}</p>
                <p class="break-words">${address1}</p>
                ${address2 ? `<p class="break-words">${address2}</p>` : ''}
                ${address3 ? `<p class="break-words">${address3}</p>` : ''}
                <p class="break-words">${city}, ${postal}</p>
                <p class="break-words">Tel: ${phone}</p>
            `;
            document.getElementById('pickup-address-display').innerHTML = addressHTML;
        });

        const timeToMinutes = (timeStr) => {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        };

        const minutesToTime = (minutes) => {
            const h = Math.floor(minutes / 60);
            const m = Math.round(minutes % 60);
            const displayHours = (h % 12) || 12;
            const ampm = h < 12 || h === 24 ? 'am' : 'pm';
            return `${displayHours}:${String(m).padStart(2, '0')} ${ampm}`;
        };

        function initializeTimeSlider() {
            const sliderEl = document.getElementById('pickup-time-slider');
            if (timeSlider) { timeSlider.destroy(); }
            
            const pips = {
                mode: 'values',
                values: [600, 660, 720, 780, 840, 900, 960, 1020, 1080],
                density: 4,
                format: { to: (value) => ([600, 720, 840, 960].includes(value) ? minutesToTime(value) : '') }
            };
            
            timeSlider = noUiSlider.create(sliderEl, {
                start: [timeToMinutes('12:15'), timeToMinutes('15:15')],
                connect: true,
                range: { 'min': timeToMinutes('09:30'), 'max': timeToMinutes('18:00') },
                step: 15,
                margin: 90,
                tooltips: [ { to: minutesToTime }, { to: minutesToTime } ],
                pips: pips,
                behaviour: 'tap-drag'
            });

            timeSlider.on('update', function(values, handle) {
                const todayStr = new Date().toISOString().slice(0, 10);
                const isToday = pickupDateInput.value === todayStr;

                if (!isToday) return;

                const now = new Date();
                const nowInMinutes = now.getHours() * 60 + now.getMinutes();
                const minAllowedTime = Math.ceil(nowInMinutes / 15) * 15;
                
                const currentStartHandleValue = parseFloat(values[0]);

                if (currentStartHandleValue < minAllowedTime) {
                    timeSlider.set([minAllowedTime, null]);
                }
            });
        }
        
        function updatePickupStepData() {
            const getVal = (id) => document.getElementById(id)?.value || '';
            const shipperName = getVal('shipper-name');
            const shipperCompany = getVal('shipper-company');
            const shipperAddress1 = getVal('shipper-address1');
            const shipperAddress2 = getVal('shipper-address2');
            const shipperAddress3 = getVal('shipper-address3');
            const shipperCity = getVal('shipper-city');
            const shipperPostal = getVal('shipper-postalcode');
            const shipperPhone = getVal('shipper-phone');

            document.getElementById('pickup-name').value = shipperName;
            document.getElementById('pickup-company').value = shipperCompany;
            document.getElementById('pickup-address1').value = shipperAddress1;
            document.getElementById('pickup-address2').value = shipperAddress2;
            document.getElementById('pickup-address3').value = shipperAddress3;
            document.getElementById('pickup-city').value = shipperCity;
            document.getElementById('pickup-postalcode').value = shipperPostal;
            document.getElementById('pickup-phone').value = shipperPhone;
            
            const addressHTML = `
                <p class="break-words"><strong>${shipperName || ''}</strong>, ${shipperCompany}</p>
                <p class="break-words">${shipperAddress1}</p>
                ${shipperAddress2 ? `<p class="break-words">${shipperAddress2}</p>` : ''}
                ${shipperAddress3 ? `<p class="break-words">${shipperAddress3}</p>` : ''}
                <p class="break-words">${shipperCity}, ${shipperPostal}</p>
                <p class="break-words">Tel: ${shipperPhone}</p>
            `;
            document.getElementById('pickup-address-display').innerHTML = addressHTML;
        }

        function generateSummary() {
            const container = document.getElementById('summary-details-content');
            
            const getVal = (id) => document.getElementById(id)?.value || 'N/A';
            const getChecked = (id) => document.getElementById(id)?.checked || false;
            
            let lineItemsHTML = '';
            document.querySelectorAll('.line-item').forEach((item, index) => {
                lineItemsHTML += `
                    <div class="border-t pt-2 mt-2">
                        <p class="font-semibold">Item #${index + 1}</p>
                        <p class="break-words">${item.querySelector('.item-description').value} - Qty: ${item.querySelector('.item-quantity').value}, Weight: ${item.querySelector('.item-weight').value} KG, Value: ${item.querySelector('.item-value').value} ${item.querySelector('.item-currency').value}</p>
                    </div>
                `;
            });

            const shipperAddress = [getVal('shipper-address1'), getVal('shipper-address2'), getVal('shipper-address3')].filter(Boolean).join(', ');
            const receiverAddress = [getVal('receiver-address1'), getVal('receiver-suburb'), getVal('receiver-address2'), getVal('receiver-address3')].filter(Boolean).join(', ');

            const isDocument = document.getElementById('ship-type-document').classList.contains('active');
            const shipmentReferenceValue = isDocument ? getVal('shipment-reference-doc') : getVal('shipment-reference-pkg');


            const summaryHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 border rounded-lg">
                        <h4 class="text-lg font-bold mb-2" data-i18n="summaryShipper"></h4>
                        <div class="space-y-1">
                            <p class="break-words"><strong>${getVal('shipper-name')}</strong>, ${getVal('shipper-company')}</p>
                            <p class="break-words">${shipperAddress}</p>
                            <p class="break-words">${getVal('shipper-city')}, ${getVal('shipper-postalcode')}, ${getVal('shipper-country-input')}</p>
                            <p class="break-words"><strong>Tel:</strong> ${getVal('shipper-phone')}</p>
                        </div>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h4 class="text-lg font-bold mb-2" data-i18n="summaryReceiver"></h4>
                        <div class="space-y-1">
                            <p class="break-words"><strong>${getVal('receiver-name')}</strong>, ${getVal('receiver-company')}</p>
                            <p class="break-words">${receiverAddress}</p>
                            <p class="break-words">${getVal('receiver-city')}, ${getVal('receiver-postalcode')}, ${getVal('receiver-country-input')}</p>
                            <p class="break-words"><strong>Tel:</strong> ${getVal('receiver-phone')}</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border rounded-lg">
                    <h4 class="text-lg font-bold mb-2" data-i18n="summaryShipmentInfo"></h4>
                    <p class="break-words"><strong>${getTranslatedText('shipmentDate')}:</strong> ${getVal('ship-date')}</p>
                    <p class="break-words"><strong>Type:</strong> ${isDocument ? getTranslatedText('document') : getTranslatedText('package')}</p>
                    <p class="break-words"><strong>Reference:</strong> ${shipmentReferenceValue || 'N/A'}</p>
                    ${isDocument ? `<p class="break-words"><strong>Description:</strong> ${getVal('document-description-input')}</p>` : ''}
                    ${!isDocument ? `
                        <p class="break-words"><strong>Insurance:</strong> ${getChecked('protect-shipment') ? getVal('insurance-value') + ' ' + document.getElementById('insurance-currency').textContent : 'No'}</p>
                        <div class="mt-2 break-words">${lineItemsHTML}</div>
                    ` : ''}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div class="p-4 border rounded-lg">
                        <h4 class="text-lg font-bold mb-2" data-i18n="summaryPackageInfo"></h4>
                        <p class="break-words"><strong>${getTranslatedText('totalPackages')}:</strong> ${document.getElementById('summary-total-packages').textContent}</p>
                        <p class="break-words"><strong>${getTranslatedText('totalWeightKg')}:</strong> ${document.getElementById('summary-total-weight-kg').textContent}</p>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h4 class="text-lg font-bold mb-2" data-i18n="summaryPaymentInfo"></h4>
                        <p class="break-words"><strong>${getTranslatedText('shipperAccount')}:</strong> ${getVal('shipper-account')}</p>
                        <p class="break-words"><strong>${getTranslatedText('billingAccount')}:</strong> ${getChecked('use-shipper-for-billing') ? getVal('shipper-account') : (getVal('billing-account') || 'N/A')}</p>
                        ${!isDocument ? `<p class="break-words"><strong>${getTranslatedText('dutiesAccount')}:</strong> ${getChecked('receiver-pays-checkbox') ? getTranslatedText('receiverWillPay') : (getVal('duties-account') || 'N/A')}</p>` : ''}
                        ${!isDocument ? `<p class="break-words"><strong>${getTranslatedText('incoterm')}:</strong> ${getVal('incoterm')}</p>` : ''}
                    </div>
                </div>

                ${document.getElementById('pickup-yes-btn').classList.contains('active') ? `
                <div class="p-4 border rounded-lg">
                    <h4 class="text-lg font-bold mb-2" data-i18n="summaryPickupInfo"></h4>
                    <p class="break-words"><strong>${getTranslatedText('requestPickup')}:</strong> ${getTranslatedText('yes')}</p>
                    <p class="break-words"><strong>${getTranslatedText('summaryPickupDate')}:</strong> ${new Date(getVal('pickup-date')+'T00:00:00').toLocaleDateString(currentLanguage === 'th' ? 'th-TH' : 'en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    <p class="break-words"><strong>${getTranslatedText('summaryPickupTime')}:</strong> ${timeSlider ? timeSlider.get().map(minutesToTime).join(' - ') : 'N/A'}</p>
                </div>` : ''}
            `;

            container.innerHTML = summaryHTML;
            updateContentLanguage();
        }

        document.getElementById('edit-summary-btn').addEventListener('click', () => changeStep(1));

        function showLeaveModal(url) {
            navigationTargetUrl = url;
            leaveModal.classList.remove('hidden');
            updateContentLanguage();
        }
        function hideLeaveModal() {
            navigationTargetUrl = null;
            leaveModal.classList.add('hidden');
        }
        stayButton.addEventListener('click', hideLeaveModal);
        leaveButton.addEventListener('click', () => {
            if (navigationTargetUrl) {
                hasUnsavedChanges = false;
                window.location.href = navigationTargetUrl;
            }
        });
        document.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', (e) => {
                if (link.getAttribute('href').startsWith('#') || link.getAttribute('href') === 'javascript:void(0)' || link.target === '_blank') return;
                if (hasUnsavedChanges) { e.preventDefault(); showLeaveModal(link.href); }
            });
        });
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = ''; return ''; }
        });

        // --- START: New function to manage length error messages ---
        function manageLengthError(inputElement, maxLength) {
            if (inputElement.id.includes('-account')) {
                return;
            }

            const wrapper = inputElement.closest('.relative');
            if (!wrapper) return;

            let errorElement = wrapper.parentElement.querySelector('.length-error-message');
            
            if (inputElement.value.length >= maxLength) {
                if (!errorElement) {
                    errorElement = document.createElement('p');
                    errorElement.className = 'length-error-message text-red-500 text-xs mt-1';
                    wrapper.insertAdjacentElement('afterend', errorElement);
                }
                errorElement.textContent = getTranslatedText('maxLengthError', { maxLength: maxLength });
            } else {
                if (errorElement) {
                    errorElement.remove();
                }
            }
        }
        // --- END: New function to manage length error messages ---

        document.getElementById('ship-now-form').addEventListener('blur', (e) => {
            const target = e.target;
            if (target.matches('input:not([type="hidden"]), select')) {
                updateInputValidationState(target);
            }
        }, true);

        document.getElementById('ship-now-form').addEventListener('input', (e) => {
            hasUnsavedChanges = true;
            const target = e.target;
            const id = target.id;

            if (id.includes('-account')) {
                let value = target.value;
                value = value.replace(/[^0-9]/g, '');
                target.value = value;
            } else {
                const asciiOnlyRegex = /[^\u0000-\u007F]/g;
                const phoneRegex = /[^\d+-]/g;
                const numberOnlyRegex = /[^\d]/g;

                const isAsciiOnlyField = id.includes('name') || 
                                         id.includes('company') || 
                                         id.includes('address') || 
                                         id.includes('postalcode') || 
                                         id.includes('shipment-reference') || 
                                         target.classList.contains('item-description') || 
                                         id === 'invoice-number' || 
                                         id === 'summarize-shipment' || 
                                         id.includes('suburb') ||
                                         id.includes('country-input') ||
                                         id.includes('city') ||
                                         id.includes('email') ||
                                         id.includes('vat');

                if (isAsciiOnlyField) {
                    let value = target.value.replace(asciiOnlyRegex, '');
                    if (id.includes('city')) {
                        value = value.toUpperCase();
                    }
                    target.value = value;
                } else if (target.type === 'tel') {
                    target.value = target.value.replace(phoneRegex, '');
                } else if (id === 'insurance-value') {
                    target.value = target.value.replace(numberOnlyRegex, '');
                }
            }

            // --- START: Updated real-time length validation and truncation ---
            let key = null;
            if (id.includes('-name')) key = 'name';
            else if (id.includes('-company')) key = 'company';
            else if (id.includes('-address1')) key = 'address1';
            else if (id.includes('-address2')) key = 'address2';
            else if (id.includes('-address3')) key = 'address3';
            else if (id.includes('-postalcode')) key = 'postalcode';
            else if (id.includes('-city')) key = 'city';
            else if (id.includes('-suburb')) key = 'suburb';
            else if (id.includes('-email')) key = 'email';
            else if (id.includes('-phone')) key = 'phone';
            else if (id.includes('-vat')) key = 'vat';
                else if (target.classList.contains('item-description')) key = 'itemDescription';
            else if (id.includes('shipment-reference')) key = 'shipmentRef';
            else if (id === 'summarize-shipment') key = 'summarizeShipment';
            else if (id === 'invoice-number') key = 'invoiceNumber';
            else if (id === 'pickup-instructions') key = 'pickupInstructions';

            if (key && validationRules[key] && validationRules[key].maxLength) {
                const maxLength = validationRules[key].maxLength;
                
                manageLengthError(target, maxLength);
                
                if (target.value.length > maxLength) {
                    target.value = target.value.slice(0, maxLength);
                }
            }
            // --- END: Updated real-time length validation and truncation ---

            // Only re-validate on input if the field is already marked as invalid
            if (target.classList.contains('is-invalid')) {
                updateInputValidationState(target);
            }
        });
        
        nextButton.addEventListener('click', () => {
            if (validateCurrentStep()) {
                const isDocument = document.getElementById('ship-type-document').classList.contains('active');
                
                if (isDocument && currentStep === 4) { // Skip from Payment to Pickup
                    changeStep(6);
                    return;
                }

                if (currentStep === 6) {
                    document.getElementById('loading-modal').classList.remove('hidden');
                    setTimeout(() => {
                        try {
                            changeStep(currentStep + 1);
                        } finally {
                            document.getElementById('loading-modal').classList.add('hidden');
                        }
                    }, 50); 
                } else if (currentStep < totalSteps) {
                    changeStep(currentStep + 1);
                }
            }
        });
        prevButton.addEventListener('click', () => {
             const isDocument = document.getElementById('ship-type-document').classList.contains('active');
             
             if (isDocument && currentStep === 6) { // Go back from Pickup to Payment
                 changeStep(4);
                 return;
             }

            if (currentStep > 1) {
                changeStep(currentStep - 1);
            }
        });
        
        document.querySelector('.progress-bar').addEventListener('click', (e) => {
            const stepElement = e.target.closest('.progress-step');
            if (!stepElement) return;

            if (stepElement.classList.contains('is-disabled')) {
                return;
            }

            const stepNumber = parseInt(stepElement.id.replace('step-', ''), 10);

            if (stepElement.classList.contains('is-complete')) {
                changeStep(stepNumber);
            }
        });

        document.getElementById('confirm-shipment-button').addEventListener('click', async (event) => {
            event.preventDefault();
            const loadingModal = document.getElementById('loading-modal');
            const formMsg = document.getElementById('form-message');
            
            const isA4 = document.getElementById('print-size-a4').classList.contains('active');
            const isLabel = document.getElementById('print-size-label').classList.contains('active');
            if (!isA4 && !isLabel) {
                formMsg.textContent = getTranslatedText('selectPrintSizeError');
                formMsg.className = 'p-4 rounded-md text-center bg-red-100 text-red-700 break-words';
                formMsg.classList.remove('hidden');
                formMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            loadingModal.classList.remove('hidden');
            formMsg.textContent = getTranslatedText('creatingShipment');
            formMsg.className = 'p-4 rounded-md text-center bg-blue-100 text-blue-700 break-words';
            formMsg.classList.remove('hidden');

            try {
                const payload = await buildShipmentPayload();
                if (!payload) {
                    throw new Error("Failed to build shipment payload.");
                }

                const backendApiUrl = 'https://sbs-back-test.vercel.app/api/ship';
                
                const response = await fetch(backendApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const responseData = await response.json();

                if (!response.ok) {
                    throw responseData;
                }
                
                sessionStorage.setItem('shipmentResponse', JSON.stringify(responseData));
                sessionStorage.setItem('shipmentLanguage', currentLanguage);
                
                hasUnsavedChanges = false; 
                window.location.href = 'confirmation.html';

            } catch (error) {
                console.error("Failed to create shipment:", error);

                let errorTitle = getTranslatedText('apiErrorTitle');
                let errorDetailsHtml = error.detail || error.message || 'An unknown error occurred.';

                if ((error.title && error.title.toLowerCase().includes("multiple problem")) || (Array.isArray(error.additionalDetails) && error.additionalDetails.length > 0)) {
                    errorTitle = getTranslatedText('multipleProblemsFound');
                    
                    let additionalDetailsContent = '';
                    if (Array.isArray(error.additionalDetails)) {
                        const detailsList = error.additionalDetails.map(detail => {
                            if (typeof detail === 'string') {
                                return `<li>${detail}</li>`;
                            } else if (detail.message) {
                                return `<li>${detail.message}</li>`;
                            }
                            return '';
                        }).join('');
                        additionalDetailsContent = `<ul class="error-details-list">${detailsList}</ul>`;
                    }
                    
                    errorDetailsHtml = `${error.detail || error.message || ''}<br>${additionalDetailsContent}`;
                }

                formMsg.innerHTML = `<div class="text-left w-full"><span class="font-bold">${errorTitle}</span><br>${errorDetailsHtml}</div>`;
                formMsg.className = 'p-4 rounded-md flex bg-red-100 text-red-700 break-words';
                formMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } finally {
                loadingModal.classList.add('hidden');
            }
        });
        
        function checkAndSetPickupDate() {
            const shipDateInput = document.getElementById('ship-date');
            const pickupDateInput = document.getElementById('pickup-date');
            
            let now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();

            const isAfterCutoff = hours > 16 || (hours === 16 && minutes > 30);

            if (isAfterCutoff) {
                now.setDate(now.getDate() + 1);
            }

            if (now.getDay() === 0) { 
                now.setDate(now.getDate() + 1);
            }

            const nextValidDateStr = now.toISOString().slice(0, 10);
            
            shipDateInput.value = nextValidDateStr;
            pickupDateInput.value = nextValidDateStr;
            
            shipDateInput.min = nextValidDateStr;
            pickupDateInput.min = nextValidDateStr;
        }

        function setupDateSync() {
            const shipDateInput = document.getElementById('ship-date');
            const pickupDateInput = document.getElementById('pickup-date');

            const syncDates = (source, destination) => {
                destination.value = source.value;
                if (timeSlider) {
                    timeSlider.destroy();
                    initializeTimeSlider();
                }
            };

            shipDateInput.addEventListener('change', () => syncDates(shipDateInput, pickupDateInput));
            pickupDateInput.addEventListener('change', () => syncDates(pickupDateInput, shipDateInput));
        }

        function initializeForm() {
             const shipperCountryInput = document.getElementById('shipper-country-input');
             const shipperCountryValue = document.getElementById('shipper-country-value');
             const shipperEmailInput = document.getElementById('shipper-email');             
             const thailand = countryList.find(c => c.countryCode === 'TH');
			 
             if (thailand) {
                shipperCountryInput.value = thailand.countryName;
                shipperCountryValue.value = thailand.countryCode;
                updateInputValidationState(shipperCountryInput);
             }
             
             const hiddenWrappers = document.querySelectorAll('#receiver-address-details-container .hidden');
             hiddenWrappers.forEach(wrapper => {
                 wrapper.querySelectorAll('input[required], select[required]').forEach(input => {
                     input.required = false;
                     input.setAttribute('data-was-required', 'true');
                 });
             });

             checkAndSetPickupDate();
             updateInputValidationState(document.getElementById('ship-date'));
             updateInputValidationState(document.getElementById('pickup-date'));

             const receiverPaysCheckbox = document.getElementById('receiver-pays-checkbox');
             if (receiverPaysCheckbox) {
                receiverPaysCheckbox.checked = true;
                receiverPaysCheckbox.dispatchEvent(new Event('change')); 
             }
             
             document.getElementById('use-my-own-invoice-btn').click();
        }

        const backendValidateUrl = 'https://sbs-back-test.vercel.app/api/validate-address';
        let addressDropdown;

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function getOrCreateAddressDropdown() {
            if (!addressDropdown) {
                addressDropdown = document.createElement('div');
                addressDropdown.className = 'address-dropdown hidden';
                document.body.appendChild(addressDropdown);
            }
            return addressDropdown;
        }

        function hideAddressDropdown() {
            const dropdown = getOrCreateAddressDropdown();
            dropdown.classList.add('hidden');
        }

        async function fetchAddressSuggestions(countryCode, value, type, inputElement, prefix) {
            if (!countryCode || value.length < 2) {
                hideAddressDropdown();
                return;
            }

            const params = new URLSearchParams({ countryCode });
            if (type === 'postalCode') {
                params.append('postalCode', value);
            } else if (type === 'city') {
                 if (value.length < 3) { 
                    hideAddressDropdown();
                    return;
                }
                params.append('city', value);
            } else if (type === 'suburb') {
                 if (value.length < 3) { 
                    hideAddressDropdown();
                    return;
                }
                params.append('countyName', value);
            }

            try {
                const response = await fetch(`${backendValidateUrl}?${params.toString()}`);
                if (!response.ok) {
                    hideAddressDropdown();
                    return;
                }
                const data = await response.json();
                displayAddressSuggestions(data, inputElement, prefix);
            } catch (error) {
                console.error('Error fetching address suggestions:', error);
                hideAddressDropdown();
            }
        }
        
        function displayAddressSuggestions(data, inputElement, prefix) {
            const dropdown = getOrCreateAddressDropdown();
            let locations = data?.postalLocationList;

            if (!locations || locations.length === 0) {
                hideAddressDropdown();
                return;
            }

            const hasPostalCodes = locations.some(loc => loc.postalCode && loc.postalCode.trim() !== '');
            // [แก้ไข] เพิ่มการเช็ค cityDistrict ด้วย
            const hasSuburbs = locations.some(loc => (loc.countyName && loc.countyName.trim() !== '') || (loc.cityDistrict && loc.cityDistrict.trim() !== ''));

            let processedLocations = [];

            if (hasPostalCodes || hasSuburbs) {
                 processedLocations = locations;
            }
            else {
                const uniqueKeys = new Set();
                processedLocations = locations.filter(loc => {
                    const key = loc.cityName || loc.city;
                    if (!key || uniqueKeys.has(key)) {
                        return false;
                    } else {
                        uniqueKeys.add(key);
                        return true;
                    }
                });
            }

            dropdown.innerHTML = processedLocations.map(loc => {
                const postalCodeData = loc.postalCode || '';
                const cityData = loc.cityName || loc.city || '';
                // [แก้ไข] เพิ่มการตรวจสอบ cityDistrict จาก API response
                const suburbData = loc.cityDistrict || loc.countyName || '';
                
                let displayTextParts = [];
                if (postalCodeData) {
                    displayTextParts.push(postalCodeData);
                }
                if (cityData) {
                    displayTextParts.push(cityData);
                }
                // เพิ่ม Suburb/District ถ้ามีและไม่ซ้ำกับชื่อเมือง
                if (suburbData && suburbData.toLowerCase() !== cityData.toLowerCase()) {
                    displayTextParts.push(`- ${suburbData}`);
                }
                const displayText = displayTextParts.join(' ');
                
                return `<div class="address-dropdown-item" data-postalcode="${postalCodeData}" data-city="${cityData}" data-suburb="${suburbData}">
                            ${displayText}
                        </div>`;
            }).join('').trim();
            
            const parentInfoBox = inputElement.closest('.p-4.border.rounded-lg');
            const rect = inputElement.getBoundingClientRect();
            
            if (parentInfoBox) {
                const parentRect = parentInfoBox.getBoundingClientRect();
                dropdown.style.left = `${parentRect.left + window.scrollX}px`;
                dropdown.style.top = `${rect.bottom + window.scrollY}px`;
                dropdown.style.width = `${parentRect.width}px`;
            } else {
                dropdown.style.left = `${rect.left + window.scrollX}px`;
                dropdown.style.top = `${rect.bottom + window.scrollY}px`;
                dropdown.style.width = `${rect.width}px`;
            }
            dropdown.classList.remove('hidden');

            dropdown.querySelectorAll('.address-dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    const postalCode = item.dataset.postalcode;
                    const city = item.dataset.city;
                    const suburb = item.dataset.suburb;
                    
                    const postalCodeInput = document.getElementById(`${prefix}-postalcode`);
                    const cityInput = document.getElementById(`${prefix}-city`);
                    const suburbInput = document.getElementById(`${prefix}-suburb`);

                    if (postalCodeInput) { postalCodeInput.value = postalCode; updateInputValidationState(postalCodeInput); }
                    if (cityInput) { cityInput.value = city; updateInputValidationState(cityInput); }
                    if (suburbInput) { suburbInput.value = suburb; updateInputValidationState(suburbInput); }
                    
                    hideAddressDropdown();
                });
            });
        }

        function setupAddressValidation(prefix) {
            const postalCodeInput = document.getElementById(`${prefix}-postalcode`);
            const cityInput = document.getElementById(`${prefix}-city`);
            const suburbInput = document.getElementById(`${prefix}-suburb`);
            const countryValueInput = document.getElementById(`${prefix}-country-value`);

            const debouncedFetch = debounce((value, type, element) => {
                const countryCode = countryValueInput.value;
                fetchAddressSuggestions(countryCode, value, type, element, prefix);
            }, 500);

            postalCodeInput.addEventListener('input', () => {
                debouncedFetch(postalCodeInput.value, 'postalCode', postalCodeInput);
            });

            cityInput.addEventListener('input', () => {
                debouncedFetch(cityInput.value, 'city', cityInput);
            });

            if (suburbInput) {
                suburbInput.addEventListener('input', () => {
                    debouncedFetch(suburbInput.value, 'suburb', suburbInput);
                });
            }
        }
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.address-dropdown') && 
                !e.target.matches('#shipper-postalcode, #shipper-city, #receiver-postalcode, #receiver-city, #receiver-suburb')) {
                hideAddressDropdown();
            }
        });

        const printA4Btn = document.getElementById('print-size-a4');
        const printLabelBtn = document.getElementById('print-size-label');
        printA4Btn.addEventListener('click', () => {
            printA4Btn.classList.add('active');
            printLabelBtn.classList.remove('active');
            formMessage.classList.add('hidden');
        });
        printLabelBtn.addEventListener('click', () => {
            printLabelBtn.classList.add('active');
            printA4Btn.classList.remove('active');
            formMessage.classList.add('hidden');
        });
        
        // --- START: Auto-fill with localStorage ---
        const fieldsToSave = [
            'shipper-name', 'shipper-company', 'shipper-address1', 'shipper-address2', 'shipper-address3', 
            'shipper-postalcode', 'shipper-city', 'shipper-email', 'shipper-phone', 'shipper-vat'
        ];

        function saveFormDataToLocalStorage() {
            let formData = {};
            fieldsToSave.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    formData[fieldId] = element.value;
                }
            });
            localStorage.setItem('dhlShipmentData', JSON.stringify(formData));
        }

        function loadFormDataFromLocalStorage() {
            const savedData = localStorage.getItem('dhlShipmentData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                for (const key in formData) {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = formData[key];
                        if (element.offsetParent !== null) updateInputValidationState(element);
                    }
                }
            }
        }
        // --- END: Auto-fill with localStorage ---


        // --- START: Initial Setup ---
        setupTheme();
        setupLanguageSwitch();
        setupCountryComboBox('shipper-country-input', 'shipper-country-value', 'shipper-country-dropdown');
        setupCountryComboBox('receiver-country-input', 'receiver-country-value', 'receiver-country-dropdown');
        setupDocumentCombobox();
        populateStaticDropdowns();
        setupMobileMenu();
        initializeForm();
        applyAllStaticValidationRules();
        initializeTimeSlider();
        setupDateSync();
        
        setupAddressValidation('shipper');
        setupAddressValidation('receiver');
        
        createPackagePiece();
        updateSummary();
        
        loadFormDataFromLocalStorage();
        
        const formToWatch = document.getElementById('ship-now-step-1'); 
        formToWatch.addEventListener('input', saveFormDataToLocalStorage);

        const clearButtons = [document.getElementById('clear-history-btn'), document.getElementById('mobile-clear-history-btn')];
        clearButtons.forEach(button => {
            if(button) {
                button.addEventListener('click', () => {
                    if (confirm(getTranslatedText('clearHistoryConfirm'))) {
                        localStorage.removeItem('dhlShipmentData');
                        
                        const form = document.getElementById('ship-now-form');
                        fieldsToSave.forEach(fieldId => {
                            const element = form.querySelector(`#${fieldId}`);
                            if(element) {
                               element.value = '';
                            }
                        });
                        location.reload();
                    }
                }
            );
        }});
        
        updateContentLanguage();
        changeStep(1);
        // --- END: Initial Setup ---
    });
    </script>
	
</body>
</html>
